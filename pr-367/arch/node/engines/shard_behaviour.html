
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="The Anoma specs is a collection of documents that describe the architecture, design, and implementation of the Anoma Network." name="description"/>
<meta content="Anoma Foundation" name="author"/>
<link href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.juvix.html" rel="canonical"/>
<link href="shard_environment.html" rel="prev"/>
<link href="executor.html" rel="next"/>
<link href="../../../assets/logo.svg" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.12+insiders-4.53.16" name="generator"/>
<title>Shard Behaviour - Anoma specs</title>
<link href="../../../assets/stylesheets/main.ff49f96f.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
<link href="../../../assets/css/juvix-material-style.css" rel="stylesheet"/>
<link href="../../../assets/css/juvix-highlighting.css" rel="stylesheet"/>
<link href="../../../assets/css/juvix_codeblock_footer.css" rel="stylesheet"/>
<link href="../../../assets/css/latte-light.css" rel="stylesheet"/>
<link href="../../../assets/css/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<meta content="website" property="og:type">
<meta content="Shard Behaviour - Anoma specs" property="og:title">
<meta content="The Anoma specs is a collection of documents that describe the architecture, design, and implementation of the Anoma Network." property="og:description">
<meta content="https://specs.anoma.net/pr-367/assets/images/social/arch/node/engines/shard_behaviour.png" property="og:image">
<meta content="image/png" property="og:image:type">
<meta content="1200" property="og:image:width"/>
<meta content="630" property="og:image:height"/>
<meta content="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.juvix.html" property="og:url"/>
<meta content="summary_large_image" property="twitter:card"/>
<meta content="Shard Behaviour - Anoma specs" property="twitter:title"/>
<meta content="The Anoma specs is a collection of documents that describe the architecture, design, and implementation of the Anoma Network." property="twitter:description"/>
<meta content="https://specs.anoma.net/pr-367/assets/images/social/arch/node/engines/shard_behaviour.png" property="twitter:image"/>
<link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></link></meta></meta></meta></meta></meta></head>
<body data-md-color-accent="indigo" data-md-color-primary="white" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#shard-behaviour">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
<aside class="md-banner">
<div class="md-banner__inner md-grid md-typeset">
<button aria-label="Don't show this again" class="md-banner__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
            
            
  For updates follow <strong>@anoma</strong> on
  <a href="https://x.com/anoma" rel="me">
<span class="twemoji x-twitter">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"></path></svg>
</span>
<strong></strong>
</a>
  and discuss on our
  <a href="https://research.anoma.net">
<span class="twemoji discourse">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M225.9 32C103.3 32 0 130.5 0 252.1 0 256 .1 480 .1 480l225.8-.2c122.7 0 222.1-102.3 222.1-223.9S348.6 32 225.9 32M224 384c-19.4 0-37.9-4.3-54.4-12.1L88.5 392l22.9-75c-9.8-18.1-15.4-38.9-15.4-61 0-70.7 57.3-128 128-128s128 57.3 128 128-57.3 128-128 128"></path></svg>
</span>
<strong>forum</strong>
</a>
</div>
<script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script>
</aside>
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Anoma specs" class="md-header__button md-logo" data-md-component="logo" href="../../../index.html" title="Anoma specs">
<img alt="logo" src="../../../assets/logo.svg"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
<span class="first-letter">A</span>noma 
              
                <span class="first-letter">s</span>pecs
              
              
                <span class="md-header__topic-version">(PR367 - ci-deploy-fix-bb30dd0f)</span>
</span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
              
                Shard Behaviour
              
            </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="white" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg>
</label>
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="red" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="white" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to system preference" class="md-option" data-md-color-accent="red" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="black" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.75.75 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.75.75 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7"></path></svg>
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.042.018.75.75 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/anoma/nspec" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</div>
<div class="md-source__repository">
    anoma/nspec
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<!--
  This is a modified version of the original mkdocs-material theme.
  Copyright (c) 2016-2025 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->
<!-- Determine classes -->
<!-- Navigation -->
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<!-- Site title -->
<label class="md-nav__title" for="__drawer">
<a aria-label="Anoma specs" class="md-nav__button md-logo" data-md-component="logo" href="../../../index.html" title="Anoma specs">
<img alt="logo" src="../../../assets/logo.svg"/>
</a>
    Anoma specs
  </label>
<!-- List of Versions -->
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="https://specs.anoma.net/latest" target="_blank">
     Latest version ((PR367 - ci-deploy-fix-bb30dd0f))
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://specs.anoma.net/main">
        Development version
      </a>
</li>
</ul>
<!-- Navigation list -->
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../index.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../changelog.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.5c-1.35-.85-3.8-1.5-5.5-1.5-1.65 0-3.35.3-4.75 1.05-.1.05-.15.05-.25.05-.25 0-.5-.25-.5-.5V6c.6-.45 1.25-.75 2-1 1.11-.35 2.33-.5 3.5-.5 1.95 0 4.05.4 5.5 1.5 1.45-1.1 3.55-1.5 5.5-1.5 1.17 0 2.39.15 3.5.5.75.25 1.4.55 2 1v14.6c0 .25-.25.5-.5.5-.1 0-.15 0-.25-.05-1.4-.75-3.1-1.05-4.75-1.05-1.7 0-4.15.65-5.5 1.5M12 8v11.5c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5V7c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5m1 3.5c1.11-.68 2.6-1 4.5-1 .91 0 1.76.09 2.5.28V9.23c-.87-.15-1.71-.23-2.5-.23q-2.655 0-4.5.84zm4.5.17c-1.71 0-3.21.26-4.5.79v1.69c1.11-.65 2.6-.99 4.5-.99 1.04 0 1.88.08 2.5.24v-1.5c-.87-.16-1.71-.23-2.5-.23m2.5 2.9c-.87-.16-1.71-.24-2.5-.24-1.83 0-3.33.27-4.5.8v1.69c1.11-.66 2.6-.99 4.5-.99 1.04 0 1.88.08 2.5.24z"></path></svg>
<span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    
  
    Indexes
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Indexes
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../indexes/tags.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5.5 7A1.5 1.5 0 0 1 4 5.5 1.5 1.5 0 0 1 5.5 4 1.5 1.5 0 0 1 7 5.5 1.5 1.5 0 0 1 5.5 7m15.91 4.58-9-9C12.05 2.22 11.55 2 11 2H4c-1.11 0-2 .89-2 2v7c0 .55.22 1.05.59 1.41l8.99 9c.37.36.87.59 1.42.59s1.05-.23 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.56-.23-1.06-.59-1.42"></path></svg>
<span class="md-ellipsis">
    
  
    List of tags
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../indexes/modules.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 10h-2V8h2m0 5h-2v-2h2m-3-1h-2V8h2m0 5h-2v-2h2m0 6H8v-2h8m-9-5H5V8h2m0 5H5v-2h2m1 0h2v2H8m0-5h2v2H8m3 1h2v2h-2m0-5h2v2h-2m9-5H4c-1.11 0-2 .89-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2"></path></svg>
<span class="md-ellipsis">
    
  
    List of modules
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../prelude.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm0 2h7v5h5v11H6zm2 8v2h8v-2zm0 4v2h5v-2z"></path></svg>
<span class="md-ellipsis">
    
  
    List of basic types
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            
  
    Introduction
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../anomian.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 3C6.5 3 2 6.6 2 11c0 2.1 1 4.1 2.8 5.5 0 .6-.4 2.2-2.8 4.5 0 0 3.5 0 6.5-2.5 1.1.3 2.3.5 3.5.5 5.5 0 10-3.6 10-8s-4.5-8-10-8m1 12h-2v-2h2zm1.8-5c-.3.4-.7.6-1.1.8-.3.2-.4.3-.5.5-.2.2-.2.4-.2.7h-2c0-.5.1-.8.3-1.1.2-.2.6-.5 1.1-.8.3-.1.5-.3.6-.5s.2-.5.2-.7c0-.3-.1-.5-.3-.7s-.5-.3-.8-.3-.5.1-.7.2q-.3.15-.3.6h-2c.1-.7.4-1.3.9-1.7s1.2-.5 2.1-.5 1.7.2 2.2.6.8 1 .8 1.7q.15.6-.3 1.2"></path></svg>
<span class="md-ellipsis">
    
  
    Anomian
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../overview.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M24 18.714v4.8c0 .288-.192.48-.48.48h-4.8c-.288 0-.48-.192-.48-.48v-4.8c0-.288.192-.48.48-.48h1.92v-1.92h-8.16v1.92h1.92c.288 0 .48.192.48.48v4.8c0 .288-.192.48-.48.48H9.6c-.288 0-.48-.192-.48-.48v-4.8c0-.288.192-.48.48-.48h1.92v-1.92H3.36v1.92h1.92c.288 0 .48.192.48.48v4.8c0 .288-.192.48-.48.48H.48c-.288 0-.48-.192-.48-.48v-4.8c0-.288.192-.48.48-.48H2.4v-2.4c0-.288.192-.48.48-.48h8.64v-1.44h.96v1.44h8.64c.288 0 .48.192.48.48v2.4h1.92c.288 0 .48.192.48.48m-13.92 4.32h3.84v-3.84h-3.84zm-9.12 0H4.8v-3.84H.96Zm18.24 0h3.84v-3.84H19.2ZM6.24 9.642V3.546c0-.192.096-.336.24-.432L11.76.042a.8.8 0 0 1 .48 0l5.28 3.072c.144.096.24.24.24.432v6.096c0 .144-.096.288-.24.384l-5.28 3.072q-.096.048-.24.048t-.24-.048l-5.28-3.072c-.144-.096-.24-.24-.24-.384m10.56-.288V4.362l-4.32 2.496v4.992zm-9.6 0 4.32 2.496V6.858L7.2 4.362Zm.48-5.808L12 5.994l4.32-2.448L12 1.05Z"></path></svg>
<span class="md-ellipsis">
    
  
    Anoma architecture
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
<span class="md-ellipsis">
    
  
    Node architecture
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            
  
    Node architecture
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../concepts/engine.html">
<span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../types/anoma_message.html">
<span class="md-ellipsis">
    
  
    Types
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Subsystems
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Subsystems
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../subsystems/hardware.html">
<span class="md-ellipsis">
    
  
    Hardware subsystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../subsystems/identity.html">
<span class="md-ellipsis">
    
  
    Identity subsystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_3_3" id="__nav_5_3_3_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Ordering subsystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_3_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_5_3_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Ordering subsystem
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../subsystems/ordering.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 5h10v2H12m0 12v-2h10v2m-10-8h10v2H12m-3 0v2l-3.33 4H9v2H3v-2l3.33-4H3v-2M7 3H5c-1.1 0-2 .9-2 2v6h2V9h2v2h2V5a2 2 0 0 0-2-2m0 4H5V5h2Z"></path></svg>
<span class="md-ellipsis">
    
  
    Ordering subsystem overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5_3_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_3_3_2" id="__nav_5_3_3_2_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Ordering subsystem engines
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_3_3_2_label" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_5_3_3_2">
<span class="md-nav__icon md-icon"></span>
            
  
    Ordering subsystem engines
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="mempool_worker.html">
<span class="md-ellipsis">
    
  
    Mempool layer
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5_3_3_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_3_3_2_2" id="__nav_5_3_3_2_2_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Execution layer
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_3_3_2_2_label" class="md-nav" data-md-level="5">
<label class="md-nav__title" for="__nav_5_3_3_2_2">
<span class="md-nav__icon md-icon"></span>
            
  
    Execution layer
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5_3_3_2_2_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_3_3_2_2_1" id="__nav_5_3_3_2_2_1_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Shard Engine
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_3_3_2_2_1_label" class="md-nav" data-md-level="6">
<label class="md-nav__title" for="__nav_5_3_3_2_2_1">
<span class="md-nav__icon md-icon"></span>
            
  
    Shard Engine
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="shard.html">
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0a8 8 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224q.347.171.668.386c.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63q.406.578.704 1.218c.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294q.024.386 0 .772c-.01.147.038.246.088.294l.814.806c.475.469.679 1.216.364 1.891a8 8 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a6 6 0 0 1-.668.386c-.133.066-.194.158-.211.224l-.29 1.106c-.168.646-.715 1.196-1.458 1.26a8 8 0 0 1-1.402 0c-.743-.064-1.289-.614-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.224a6 6 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8 8 0 0 1-.704-1.218c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6 6 0 0 1 0-.772c.01-.147-.038-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a8 8 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071q.321-.215.668-.386c.133-.066.194-.158.211-.224l.29-1.106C6.009.645 6.556.095 7.299.03Q7.646 0 8 0m-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.105c-.147.561-.549.967-.998 1.189q-.26.13-.5.29c-.417.278-.97.423-1.529.27l-1.103-.303c-.109-.03-.175.016-.195.045q-.33.47-.573.99c-.014.031-.021.11.059.19l.815.806c.411.406.562.957.53 1.456a5 5 0 0 0 0 .582c.032.499-.119 1.05-.53 1.456l-.815.806c-.081.08-.073.159-.059.19q.243.52.573.989c.02.03.085.076.195.046l1.102-.303c.56-.153 1.113-.008 1.53.27q.242.16.501.29c.447.222.85.629.997 1.189l.289 1.105c.029.109.101.143.137.146a6.6 6.6 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.105c.147-.561.549-.967.998-1.189q.26-.13.5-.29c.417-.278.97-.423 1.529-.27l1.103.303c.109.029.175-.016.195-.045q.33-.47.573-.99c.014-.031.021-.11-.059-.19l-.815-.806c-.411-.406-.562-.957-.53-1.456a5 5 0 0 0 0-.582c-.032-.499.119-1.05.53-1.456l.815-.806c.081-.08.073-.159.059-.19a6.5 6.5 0 0 0-.573-.989c-.02-.03-.085-.076-.195-.046l-1.102.303c-.56.153-1.113.008-1.53-.27a4.4 4.4 0 0 0-.501-.29c-.447-.222-.85-.629-.997-1.189l-.289-1.105c-.029-.11-.101-.143-.137-.146a6.6 6.6 0 0 0-1.142 0M11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0M9.5 8a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8"></path></svg>
<span class="md-ellipsis">
    
  
    Shard Engine
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="shard_messages.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 14h-7.5l2-2H18M6 14v-2.5l6.88-6.86c.19-.19.51-.19.71 0l1.76 1.77c.2.2.2.51 0 .71L8.47 14M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2"></path></svg>
<span class="md-ellipsis">
    
  
    Shard Messages
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="shard_config.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13.152.682a2.25 2.25 0 0 1 2.269 0l.007.004 6.957 4.276a2.28 2.28 0 0 1 1.126 1.964v7.516c0 .81-.432 1.56-1.133 1.968l-.002.001-11.964 7.037-.004.003c-.706.41-1.578.41-2.284 0l-.026-.015-6.503-4.502a2.27 2.27 0 0 1-1.096-1.943V9.438c0-.392.1-.77.284-1.1l.003-.006.014-.026c.197-.342.48-.627.82-.827h.002L13.152.681Zm.757 1.295h-.001L2.648 8.616l6.248 4.247a.78.78 0 0 0 .758-.01h.001l11.633-6.804-6.629-4.074a.75.75 0 0 0-.75.003ZM8.517 14.33a2.3 2.3 0 0 1-.393-.18l-.023-.014-6.102-4.147v7.003c0 .275.145.528.379.664l.025.014 6.114 4.232zM18 9.709l-3.25 1.9v7.548L18 17.245Zm-7.59 4.438-.002.002a2.3 2.3 0 0 1-.391.18v7.612l3.233-1.902v-7.552Zm9.09-5.316v7.532l2.124-1.25a.78.78 0 0 0 .387-.671V7.363Z"></path></svg>
<span class="md-ellipsis">
    
  
    Shard Configuration
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="shard_environment.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13.152.682a2.25 2.25 0 0 1 2.269 0l.007.004 6.957 4.276a2.28 2.28 0 0 1 1.126 1.964v7.516c0 .81-.432 1.56-1.133 1.968l-.002.001-11.964 7.037-.004.003c-.706.41-1.578.41-2.284 0l-.026-.015-6.503-4.502a2.27 2.27 0 0 1-1.096-1.943V9.438c0-.392.1-.77.284-1.1l.003-.006.014-.026c.197-.342.48-.627.82-.827h.002L13.152.681Zm.757 1.295h-.001L2.648 8.616l6.248 4.247a.78.78 0 0 0 .758-.01h.001l11.633-6.804-6.629-4.074a.75.75 0 0 0-.75.003ZM8.517 14.33a2.3 2.3 0 0 1-.393-.18l-.023-.014-6.102-4.147v7.003c0 .275.145.528.379.664l.025.014 6.114 4.232zM18 9.709l-3.25 1.9v7.548L18 17.245Zm-7.59 4.438-.002.002a2.3 2.3 0 0 1-.391.18v7.612l3.233-1.902v-7.552Zm9.09-5.316v7.532l2.124-1.25a.78.78 0 0 0 .387-.671V7.363Z"></path></svg>
<span class="md-ellipsis">
    
  
    Shard Environment
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 2h10v2H4v10H2V4c0-1.11.89-2 2-2m4 4h10v2H8v10H6V8c0-1.11.89-2 2-2m4 4h8c1.11 0 2 .89 2 2v8c0 1.11-.89 2-2 2h-8c-1.11 0-2-.89-2-2v-8c0-1.11.89-2 2-2m2 2v8l6-4z"></path></svg>
<span class="md-ellipsis">
    
  
    Shard Behaviour
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="shard_behaviour.html">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 2h10v2H4v10H2V4c0-1.11.89-2 2-2m4 4h10v2H8v10H6V8c0-1.11.89-2 2-2m4 4h8c1.11 0 2 .89 2 2v8c0 1.11-.89 2-2 2h-8c-1.11 0-2-.89-2-2v-8c0-1.11.89-2 2-2m2 2v8l6-4z"></path></svg>
<span class="md-ellipsis">
    
  
    Shard Behaviour
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#shard-action-flowchart">
<span class="md-ellipsis">
      
        Shard Action Flowchart
      
    </span>
</a>
<nav aria-label="Shard Action Flowchart" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#acquirelock-flowchart">
<span class="md-ellipsis">
      
        acquireLock Flowchart
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processwrite-flowchart">
<span class="md-ellipsis">
      
        processWrite Flowchart
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processreadrequest-flowchart">
<span class="md-ellipsis">
      
        processReadRequest Flowchart
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updateseenall-flowchart">
<span class="md-ellipsis">
      
        updateSeenAll Flowchart
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#action-arguments">
<span class="md-ellipsis">
      
        Action arguments
      
    </span>
</a>
<nav aria-label="Action arguments" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactionargument">
<span class="md-ellipsis">
      
        ShardActionArgument
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactionarguments">
<span class="md-ellipsis">
      
        ShardActionArguments
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#helper-functions">
<span class="md-ellipsis">
      
        Helper Functions
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#actions">
<span class="md-ellipsis">
      
        Actions
      
    </span>
</a>
<nav aria-label="Actions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shardaction">
<span class="md-ellipsis">
      
        ShardAction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactioninput">
<span class="md-ellipsis">
      
        ShardActionInput
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactioneffect">
<span class="md-ellipsis">
      
        ShardActionEffect
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactionexec">
<span class="md-ellipsis">
      
        ShardActionExec
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#acquirelockaction">
<span class="md-ellipsis">
      
        acquireLockAction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processwriteaction">
<span class="md-ellipsis">
      
        processWriteAction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processreadrequestaction">
<span class="md-ellipsis">
      
        processReadRequestAction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updateseenallaction">
<span class="md-ellipsis">
      
        updateSeenAllAction
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#action-labels">
<span class="md-ellipsis">
      
        Action Labels
      
    </span>
</a>
<nav aria-label="Action Labels" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#acquirelockactionlabel">
<span class="md-ellipsis">
      
        acquireLockActionLabel
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processwriteactionlabel">
<span class="md-ellipsis">
      
        processWriteActionLabel
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processreadrequestactionlabel">
<span class="md-ellipsis">
      
        processReadRequestActionLabel
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updateseenallactionlabel">
<span class="md-ellipsis">
      
        updateSeenAllActionLabel
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#guards">
<span class="md-ellipsis">
      
        Guards
      
    </span>
</a>
<nav aria-label="Guards" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shardguard">
<span class="md-ellipsis">
      
        ShardGuard
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardguardoutput">
<span class="md-ellipsis">
      
        ShardGuardOutput
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardguardeval">
<span class="md-ellipsis">
      
        ShardGuardEval
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#acquirelockguard">
<span class="md-ellipsis">
      
        acquireLockGuard
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processwriteguard">
<span class="md-ellipsis">
      
        processWriteGuard
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processreadrequestguard">
<span class="md-ellipsis">
      
        processReadRequestGuard
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updateseenallguard">
<span class="md-ellipsis">
      
        updateSeenAllGuard
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-shard-behaviour">
<span class="md-ellipsis">
      
        The Shard Behaviour
      
    </span>
</a>
<nav aria-label="The Shard Behaviour" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shardbehaviour">
<span class="md-ellipsis">
      
        ShardBehaviour
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="executor.html">
<span class="md-ellipsis">
    
  
    Executor Engine
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../subsystems/net.html">
<span class="md-ellipsis">
    
  
    Network subsystem
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
<span class="md-ellipsis">
    
  
    System architecture
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            
  
    System architecture
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../system/identity/identity.html">
<span class="md-ellipsis">
    
  
    Identity Architecture
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../system/state/resource_machine/index.html">
<span class="md-ellipsis">
    
  
    State Architecture
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
<span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../../tutorial/principles_and_guidelines.html">
<span class="md-ellipsis">
    
  
    Contributor guidelines
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#shard-action-flowchart">
<span class="md-ellipsis">
      
        Shard Action Flowchart
      
    </span>
</a>
<nav aria-label="Shard Action Flowchart" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#acquirelock-flowchart">
<span class="md-ellipsis">
      
        acquireLock Flowchart
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processwrite-flowchart">
<span class="md-ellipsis">
      
        processWrite Flowchart
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processreadrequest-flowchart">
<span class="md-ellipsis">
      
        processReadRequest Flowchart
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updateseenall-flowchart">
<span class="md-ellipsis">
      
        updateSeenAll Flowchart
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#action-arguments">
<span class="md-ellipsis">
      
        Action arguments
      
    </span>
</a>
<nav aria-label="Action arguments" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactionargument">
<span class="md-ellipsis">
      
        ShardActionArgument
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactionarguments">
<span class="md-ellipsis">
      
        ShardActionArguments
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#helper-functions">
<span class="md-ellipsis">
      
        Helper Functions
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#actions">
<span class="md-ellipsis">
      
        Actions
      
    </span>
</a>
<nav aria-label="Actions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shardaction">
<span class="md-ellipsis">
      
        ShardAction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactioninput">
<span class="md-ellipsis">
      
        ShardActionInput
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactioneffect">
<span class="md-ellipsis">
      
        ShardActionEffect
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardactionexec">
<span class="md-ellipsis">
      
        ShardActionExec
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#acquirelockaction">
<span class="md-ellipsis">
      
        acquireLockAction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processwriteaction">
<span class="md-ellipsis">
      
        processWriteAction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processreadrequestaction">
<span class="md-ellipsis">
      
        processReadRequestAction
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updateseenallaction">
<span class="md-ellipsis">
      
        updateSeenAllAction
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#action-labels">
<span class="md-ellipsis">
      
        Action Labels
      
    </span>
</a>
<nav aria-label="Action Labels" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#acquirelockactionlabel">
<span class="md-ellipsis">
      
        acquireLockActionLabel
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processwriteactionlabel">
<span class="md-ellipsis">
      
        processWriteActionLabel
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processreadrequestactionlabel">
<span class="md-ellipsis">
      
        processReadRequestActionLabel
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updateseenallactionlabel">
<span class="md-ellipsis">
      
        updateSeenAllActionLabel
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#guards">
<span class="md-ellipsis">
      
        Guards
      
    </span>
</a>
<nav aria-label="Guards" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shardguard">
<span class="md-ellipsis">
      
        ShardGuard
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardguardoutput">
<span class="md-ellipsis">
      
        ShardGuardOutput
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shardguardeval">
<span class="md-ellipsis">
      
        ShardGuardEval
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#acquirelockguard">
<span class="md-ellipsis">
      
        acquireLockGuard
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processwriteguard">
<span class="md-ellipsis">
      
        processWriteGuard
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#processreadrequestguard">
<span class="md-ellipsis">
      
        processReadRequestGuard
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updateseenallguard">
<span class="md-ellipsis">
      
        updateSeenAllGuard
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-shard-behaviour">
<span class="md-ellipsis">
      
        The Shard Behaviour
      
    </span>
</a>
<nav aria-label="The Shard Behaviour" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#shardbehaviour">
<span class="md-ellipsis">
      
        ShardBehaviour
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<nav aria-label="Navigation" class="md-path">
<ol class="md-path__list">
<li class="md-path__item">
<a class="md-path__link" href="../../../index.html">
<span class="md-ellipsis">
    Home
  </span>
</a>
</li>
<li class="md-path__item">
<a class="md-path__link" href="../concepts/engine.html">
<span class="md-ellipsis">
    Node architecture
  </span>
</a>
</li>
<li class="md-path__item">
<a class="md-path__link" href="../subsystems/hardware.html">
<span class="md-ellipsis">
    Subsystems
  </span>
</a>
</li>
<li class="md-path__item">
<a class="md-path__link" href="../subsystems/ordering.html">
<span class="md-ellipsis">
    Ordering subsystem
  </span>
</a>
</li>
<li class="md-path__item">
<a class="md-path__link" href="mempool_worker.html">
<span class="md-ellipsis">
    Ordering subsystem engines
  </span>
</a>
</li>
<li class="md-path__item">
<a class="md-path__link" href="shard.html">
<span class="md-ellipsis">
    Execution layer
  </span>
</a>
</li>
<li class="md-path__item">
<a class="md-path__link" href="shard.html">
<span class="md-ellipsis">
    Shard Engine
  </span>
</a>
</li>
</ol>
</nav>
<article class="md-content__inner md-typeset">
<!--
  This is a modified version of the original mkdocs-material theme.
  Copyright (c) 2016-2025 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->
<!-- Tags -->
<nav class="md-tags">
<a class="md-tag" href="../../../indexes/tags.html#tag:behaviour">behaviour</a>
<a class="md-tag" href="../../../indexes/tags.html#tag:engine">engine</a>
<a class="md-tag" href="../../../indexes/tags.html#tag:node-architecture">node-architecture</a>
<a class="md-tag" href="../../../indexes/tags.html#tag:ordering-subsystem">ordering-subsystem</a>
<a class="md-tag" href="../../../indexes/tags.html#tag:shard">shard</a>
</nav>
<!-- Actions -->
<!--
  Copyright (c) 2016-2025 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->
<!-- Actions -->
<!-- Edit button -->
<a class="md-content__button md-icon" href="https://github.com/anoma/nspec/edit/main/docs/arch/node/engines/shard_behaviour.juvix.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 2c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-1.9l10-10V8l-6-6zm7 1.5L18.5 9H13zm7.1 9.5c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-2 1.8L12 20.9V23h2.1l6.1-6.1z"></path></svg>
</a>
<!-- View button -->
<a class="md-content__button md-icon" href="https://github.com/anoma/nspec/raw/main/docs/arch/node/engines/shard_behaviour.juvix.md" title="View source of this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.56 18H3.44C2.65 18 2 17.37 2 16.59V7.41C2 6.63 2.65 6 3.44 6h17.12c.79 0 1.44.63 1.44 1.41v9.18c0 .78-.65 1.41-1.44 1.41M6.81 15.19v-3.66l1.92 2.35 1.92-2.35v3.66h1.93V8.81h-1.93l-1.92 2.35-1.92-2.35H4.89v6.38zM19.69 12h-1.92V8.81h-1.92V12h-1.93l2.89 3.28z"></path></svg>
</a>
<!-- If the page source ends with .juvix.md, we show a button to view the raw code -->
<a class="md-content__button md-icon" href="arch/node/engines/shard_behaviour-src.html" title="View Raw Juvix Code">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8 3a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2H3v2h1a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h2v-2H8v-5a2 2 0 0 0-2-2 2 2 0 0 0 2-2V5h2V3m6 0a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h1v2h-1a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2h-2v-2h2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5h-2V3z"></path></svg>
</a>
<!--
  Hack: check whether the content contains a h1 headline. If it doesn't, the
  page title (or respectively site name) is used as the main headline.
-->
<!-- Page content -->
<details class="code">
<summary>Juvix imports</summary>
<p><pre class="highlight"><code class="juvix"><pre class="src-content"><span class="ju-keyword">module</span> <span id="arch.node.engines.shard_behaviour"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour"><span class="ju-module"><span class="ju-module">arch.node.engines.shard_behaviour</span></span></a></span></a></span></span><span class="ju-delimiter">;</span><br/><br/><span class="ju-keyword">import</span> <span id="arch.node.engines.shard_messages"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#arch.node.engines.shard_messages"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#arch.node.engines.shard_messages"><span class="ju-module"><span class="ju-module">arch.node.engines.shard_messages</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="arch.node.engines.shard_config"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#arch.node.engines.shard_config"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#arch.node.engines.shard_config"><span class="ju-module"><span class="ju-module">arch.node.engines.shard_config</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="arch.node.engines.shard_environment"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#arch.node.engines.shard_environment"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#arch.node.engines.shard_environment"><span class="ju-module"><span class="ju-module">arch.node.engines.shard_environment</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="Stdlib.Data.Nat"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/Nat.html#Stdlib.Data.Nat"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/Nat.html#Stdlib.Data.Nat"><span class="ju-module"><span class="ju-module">Stdlib.Data.Nat</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="Stdlib.Data.List"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/List.html#Stdlib.Data.List"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/List.html#Stdlib.Data.List"><span class="ju-module"><span class="ju-module">Stdlib.Data.List</span></span></a></span></a></span></span> <span class="ju-keyword">as</span> <span id="Stdlib.Data.List"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/List.html#Stdlib.Data.List"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/List.html#Stdlib.Data.List"><span class="ju-module"><span class="ju-module">List</span></span></a></span></a></span></span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="Stdlib.Data.Set"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/Set.html#Stdlib.Data.Set"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/Set.html#Stdlib.Data.Set"><span class="ju-module"><span class="ju-module">Stdlib.Data.Set</span></span></a></span></a></span></span> <span class="ju-keyword">as</span> <span id="Stdlib.Data.Set"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/Set.html#Stdlib.Data.Set"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/Stdlib/Data/Set.html#Stdlib.Data.Set"><span class="ju-module"><span class="ju-module">Set</span></span></a></span></a></span></span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="prelude"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/prelude.html#prelude"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/prelude.html#prelude"><span class="ju-module"><span class="ju-module">prelude</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="arch.node.types.basics"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/basics.html#arch.node.types.basics"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/basics.html#arch.node.types.basics"><span class="ju-module"><span class="ju-module">arch.node.types.basics</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="arch.node.types.identities"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#arch.node.types.identities"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#arch.node.types.identities"><span class="ju-module"><span class="ju-module">arch.node.types.identities</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="arch.node.types.messages"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#arch.node.types.messages"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#arch.node.types.messages"><span class="ju-module"><span class="ju-module">arch.node.types.messages</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="arch.node.types.engine"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/engine.html#arch.node.types.engine"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/engine.html#arch.node.types.engine"><span class="ju-module"><span class="ju-module">arch.node.types.engine</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/><span class="ju-keyword">import</span> <span id="arch.node.types.anoma"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/anoma.html#arch.node.types.anoma"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/anoma.html#arch.node.types.anoma"><span class="ju-module"><span class="ju-module">arch.node.types.anoma</span></span></a></span></a></span></span> <span class="ju-keyword">as</span> <span id="arch.node.types.anoma"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/anoma.html#arch.node.types.anoma"><span class="annot"><a class="ju-code-link ju-module" href="https://specs.anoma.net/pr-367/arch/node/types/anoma.html#arch.node.types.anoma"><span class="ju-module"><span class="ju-module">Anoma</span></span></a></span></a></span></span> <span class="ju-keyword">open</span><span class="ju-delimiter">;</span><br/></pre></code></pre></p>
</details>
<h1 id="shard-behaviour">Shard Behaviour<a class="headerlink" href="#shard-behaviour" title="Anchor link to this section for reference">¶</a></h1>
<h2 id="shard-action-flowchart">Shard Action Flowchart<a class="headerlink" href="#shard-action-flowchart" title="Anchor link to this section for reference">¶</a></h2>
<h3 id="acquirelock-flowchart"><code>acquireLock</code> Flowchart<a class="headerlink" href="#acquirelock-flowchart" title="Anchor link to this section for reference">¶</a></h3>
<figure>
<pre class="mermaid"><code>flowchart TD
    Start([Worker Request]) --&gt; MsgReq[ShardMsgKVSAcquireLock&lt;br/&gt;keys, worker, executor, timestamp]

    subgraph Guard["acquireLockGuard"]
        MsgReq --&gt; ValidType{Is message type&lt;br/&gt;KVSAcquireLock?}
        ValidType --&gt;|No| Reject([Reject Request])
        ValidType --&gt;|Yes| ActionEntry[Enter Action Phase]
    end

    ActionEntry --&gt; Action

    subgraph Action["acquireLockAction"]
        direction TB
        AddReads[Add read accesses to DAG&lt;br/&gt;eager and lazy]
        AddReads --&gt; AddWrites[Add write accesses to DAG&lt;br/&gt;definite and potential]
        AddWrites --&gt; CheckEager{Any eager reads&lt;br/&gt;ready to execute?}
        CheckEager --&gt;|Yes| PrepReadMsgs[Create read messages&lt;br/&gt;for eligible keys]
        CheckEager --&gt;|No| SkipReads[Skip read messages]
        PrepReadMsgs &amp; SkipReads --&gt; PrepareLockAck[Create lock acquired&lt;br/&gt;response]
    end

    PrepareLockAck --&gt; Msgs[Send Messages]

    subgraph Msgs["Messages Sent"]
        LockAck[KVSLockAcquired to Worker]
        ReadMsgs[KVSRead messages to Executor&lt;br/&gt;for eligible eager reads]
    end</code></pre>
<figcaption>
<code>acquireLock</code> flowchart
</figcaption>
</figure>
<h4 id="explanation">Explanation<a class="headerlink" href="#explanation" title="Anchor link to this section for reference">¶</a></h4>
<ol>
<li>
<p><strong>Initial Request</strong></p>
<ul>
<li>A Mempool Worker sends a <code>ShardMsgKVSAcquireLock</code> containing:<ul>
<li><code>lazy_read_keys</code>: Keys that might be read during execution.</li>
<li><code>eager_read_keys</code>: Keys that will definitely be read.</li>
<li><code>will_write_keys</code>: Keys that will definitely be written.</li>
<li><code>may_write_keys</code>: Keys that might be written.</li>
<li><code>worker</code>: ID of the requesting worker engine.</li>
<li><code>executor</code>: ID of the executor that will process this transaction.</li>
<li><code>timestamp</code>: Logical timestamp for transaction ordering.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Guard Phase</strong> (<code>acquireLockGuard</code>)</p>
<ul>
<li>Verifies message type is <code>ShardMsgKVSAcquireLock</code>.</li>
<li>If validation fails, request is rejected immediately.</li>
<li>On success, passes control to <code>acquireLockActionLabel</code>.</li>
</ul>
</li>
<li>
<p><strong>Action Phase</strong> (<code>acquireLockAction</code>)</p>
<ul>
<li>Processes valid lock requests through these steps:<ul>
<li>Adds read accesses to DAG for both eager and lazy reads.</li>
<li>Adds write accesses to DAG for both definite and potential writes.</li>
<li>Checks for any eager reads that are immediately eligible for execution.</li>
<li>Creates read messages for eligible eager reads.</li>
<li>Prepares lock acquisition acknowledgment.</li>
<li>Records all lock information in DAG structure.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Reply Generation</strong></p>
<ul>
<li><strong>Always Sends</strong>:<ul>
<li><code>KVSLockAcquired</code> message back to worker containing:<ul>
<li><code>timestamp</code>: Same timestamp as request.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Conditionally Sends</strong>:<ul>
<li>If eligible eager reads found:<ul>
<li><code>KVSRead</code> messages to executor containing:<ul>
<li><code>timestamp</code>: Transaction timestamp.</li>
<li><code>key</code>: Key that was read.</li>
<li><code>data</code>: Value at that timestamp.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Reply Delivery</strong></p>
<ul>
<li>Lock acknowledgment sent to original worker.</li>
<li>Any read messages sent to specified executor.</li>
<li>Uses mailbox 0 (the standard mailbox for responses).</li>
</ul>
</li>
</ol>
<h3 id="processwrite-flowchart"><code>processWrite</code> Flowchart<a class="headerlink" href="#processwrite-flowchart" title="Anchor link to this section for reference">¶</a></h3>
<figure>
<pre class="mermaid"><code>flowchart TD
    Start([Executor Request]) --&gt; MsgReq[ShardMsgKVSWrite&lt;br/&gt;key, timestamp, data]

    subgraph Guard["processWriteGuard"]
        MsgReq --&gt; ValidType{Is message type&lt;br/&gt;KVSWrite?}
        ValidType --&gt;|No| Reject([Reject Request])
        ValidType --&gt;|Yes| ActionEntry[Enter Action Phase]
    end

    ActionEntry --&gt; Action

    subgraph Action["processWriteAction"]
        direction TB
        CheckLock{Write lock&lt;br/&gt;exists for timestamp?}
        CheckLock --&gt;|No| FailNoLock[Fail - No Lock]
        CheckLock --&gt;|Yes| ValidateWrite{Valid write for&lt;br/&gt;lock type?}
        ValidateWrite --&gt;|No| FailInvalid[Fail - Invalid Write]
        ValidateWrite --&gt;|Yes| UpdateDAG[Update DAG with&lt;br/&gt;write data]
        UpdateDAG --&gt; CheckReads{Eager reads&lt;br/&gt;now eligible?}
        CheckReads --&gt;|Yes| PrepReadMsgs[Create read messages&lt;br/&gt;for eligible keys]
        CheckReads --&gt;|No| NoReads[No messages needed]
    end

    PrepReadMsgs --&gt; SendReads[Send KVSRead messages&lt;br/&gt;to eligible executors]
    NoReads --&gt; Complete([Complete])
    FailNoLock &amp; FailInvalid --&gt; Fail([Fail - No Reply])</code></pre>
<figcaption>
<code>processWrite</code> flowchart
</figcaption>
</figure>
<h4 id="explanation_1">Explanation<a class="headerlink" href="#explanation_1" title="Anchor link to this section for reference">¶</a></h4>
<ol>
<li>
<p><strong>Initial Request</strong></p>
<ul>
<li>A client sends a <code>ShardMsgKVSWrite</code> containing:<ul>
<li><code>key</code>: The state key to write to.</li>
<li><code>timestamp</code>: The transaction's logical timestamp.</li>
<li><code>datum</code>: The value to write (or None for null writes).</li>
</ul>
</li>
<li>This request comes from an Executor Engine that previously acquired write locks.</li>
</ul>
</li>
<li>
<p><strong>Guard Phase</strong> (<code>processWriteGuard</code>)</p>
<ul>
<li>Verifies message type is <code>ShardMsgKVSWrite</code>.</li>
<li>If validation fails, request is rejected immediately.</li>
<li>On success, passes control to <code>processWriteActionLabel</code>.</li>
</ul>
</li>
<li>
<p><strong>Action Phase</strong> (<code>processWriteAction</code>)</p>
<ul>
<li>Processes valid write requests through these steps:<ul>
<li>Checks if write lock exists for the key at given timestamp.</li>
<li>Validates write against lock type (null writes only valid for <code>mayWrite</code> locks).</li>
<li>Updates DAG structure with new write data.</li>
<li>Checks for eligible eager reads that can now proceed.</li>
<li>Constructs appropriate read messages for any newly eligible reads.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Error Cases</strong></p>
<ul>
<li><strong>No Lock Case</strong>: Returns none if:<ul>
<li>No write access exists for the timestamp.</li>
<li>Write access exists but no <code>writeStatus</code> (no write lock).</li>
</ul>
</li>
<li><strong>Invalid Write Case</strong>: Returns none if:<ul>
<li>Attempting null write on definite write lock.</li>
<li>Lock exists but write is invalid for lock type.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Reply Delivery</strong></p>
<ul>
<li>On success, sends <code>KVSRead</code> messages to Executors for any eligible eager reads.</li>
<li>The original write request does not receive a direct response.</li>
<li>All messages use mailbox 0 (the standard mailbox for responses).</li>
</ul>
</li>
</ol>
<h3 id="processreadrequest-flowchart"><code>processReadRequest</code> Flowchart<a class="headerlink" href="#processreadrequest-flowchart" title="Anchor link to this section for reference">¶</a></h3>
<figure>
<pre class="mermaid"><code>flowchart TD
    Start([Executor Request]) --&gt; MsgReq[ShardMsgKVSReadRequest&lt;br/&gt;key, timestamp, actual]

    subgraph Guard["processReadRequestGuard"]
        MsgReq --&gt; ValidType{Is message type&lt;br/&gt;KVSReadRequest?}
        ValidType --&gt;|No| Reject([Reject Request])
        ValidType --&gt;|Yes| ActionEntry[Enter Action Phase]
    end

    ActionEntry --&gt; Action

    subgraph Action["processReadRequestAction"]
        direction TB
        CheckBarrier{timestamp &gt;=&lt;br/&gt;heardAllReads?}
        CheckBarrier --&gt;|No| FailTooEarly[Fail - Too Early]
        CheckBarrier --&gt;|Yes| CheckLock{Read lock&lt;br/&gt;exists?}
        CheckLock --&gt;|No| FailNoLock[Fail - No Lock]
        CheckLock --&gt;|Yes| MarkRead[Mark read as completed&lt;br/&gt;in DAG]
        MarkRead --&gt; CheckActual{actual flag&lt;br/&gt;true?}
        CheckActual --&gt;|No| NoReply[No response needed]
        CheckActual --&gt;|Yes| FindValue[Find most recent&lt;br/&gt;write before timestamp]
        FindValue --&gt; HasValue{Value found?}
        HasValue --&gt;|No| FailNoValue[Fail - No Value]
        HasValue --&gt;|Yes| PrepReply[Create read response&lt;br/&gt;with found value]
    end

    PrepReply --&gt; SendRead[Send KVSRead message&lt;br/&gt;to executor]
    NoReply --&gt; Complete([Complete])
    FailTooEarly &amp; FailNoLock &amp; FailNoValue --&gt; Fail([Fail - No Reply])

    style Guard fill:#f0f7ff,stroke:#333,stroke-width:2px
    style Action fill:#fff7f0,stroke:#333,stroke-width:2px</code></pre>
<figcaption>
<code>processReadRequest</code> flowchart
</figcaption>
</figure>
<h4 id="explanation_2">Explanation<a class="headerlink" href="#explanation_2" title="Anchor link to this section for reference">¶</a></h4>
<ol>
<li>
<p><strong>Initial Request</strong></p>
<ul>
<li>An executor sends a <code>ShardMsgKVSReadRequest</code> containing:<ul>
<li><code>key</code>: The state key to read.</li>
<li><code>timestamp</code>: The logical timestamp of the requesting transaction.</li>
<li><code>actual</code>: Boolean flag indicating if this is a real read or just cleanup.</li>
</ul>
</li>
<li>The key must be one that this shard is responsible for managing.</li>
</ul>
</li>
<li>
<p><strong>Guard Phase</strong> (<code>processReadRequestGuard</code>)</p>
<ul>
<li>Verifies message type is <code>ShardMsgKVSReadRequest</code>.</li>
<li>If validation fails, request is rejected immediately.</li>
<li>On success, passes control to <code>processReadRequestActionLabel</code>.</li>
</ul>
</li>
<li>
<p><strong>Action Phase</strong> (<code>processReadRequestAction</code>)</p>
<ul>
<li>Processes valid read requests through these steps:<ul>
<li>Checks if timestamp is at or after the <code>heardAllReads</code> barrier.</li>
<li>Verifies a read lock exists for this key at this timestamp.</li>
<li>Marks the read as completed in the DAG structure.</li>
<li>If <code>actual</code> flag is true, finds the most recent write value.</li>
<li>Constructs appropriate response based on result.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Reply Generation</strong></p>
<ul>
<li><strong>Successful Case (actual = true)</strong><ul>
<li>Creates <code>ShardMsgKVSRead</code> with:<ul>
<li><code>timestamp</code>: Original request timestamp.</li>
<li><code>key</code>: Original request key.</li>
<li><code>data</code>: Found historical value.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Successful Case (actual = false)</strong><ul>
<li>No response message generated.</li>
<li>Only updates internal state.</li>
</ul>
</li>
<li><strong>Error Cases</strong><ul>
<li>No response sent if:<ul>
<li>Timestamp is before <code>heardAllReads</code>.</li>
<li>No valid read lock exists.</li>
<li>No historical value found.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Reply Delivery</strong></p>
<ul>
<li>Success response sent directly to requesting executor.</li>
<li>Uses mailbox 0 (the standard mailbox for responses).</li>
</ul>
</li>
</ol>
<h3 id="updateseenall-flowchart"><code>updateSeenAll</code> Flowchart<a class="headerlink" href="#updateseenall-flowchart" title="Anchor link to this section for reference">¶</a></h3>
<figure>
<pre class="mermaid"><code>flowchart TD
    Start([Worker Request]) --&gt; MsgReq[ShardMsgUpdateSeenAll&lt;br/&gt;timestamp, write]

    subgraph Guard["updateSeenAllGuard"]
        MsgReq --&gt; ValidType{Is message type&lt;br/&gt;UpdateSeenAll?}
        ValidType --&gt;|No| Reject([Reject Request])
        ValidType --&gt;|Yes| ActionEntry[Enter Action Phase]
    end

    ActionEntry --&gt; Action

    subgraph Action["updateSeenAllAction"]
        direction TB
        CheckType{What kind&lt;br/&gt;of barrier?}
        CheckType --&gt;|write| UpdateWrites[Update heardAllWrites&lt;br/&gt;barrier]
        CheckType --&gt;|read| UpdateReads[Update heardAllReads&lt;br/&gt;barrier]
        UpdateWrites --&gt; CheckEager{Eager reads&lt;br/&gt;now eligible?}
        UpdateReads --&gt; NoReads[No reads to process]
        CheckEager --&gt;|Yes| PrepReadMsgs[Create read messages&lt;br/&gt;for eligible keys]
        CheckEager --&gt;|No| NoNewReads[No new reads eligible]
    end

    PrepReadMsgs --&gt; SendReads[Send KVSRead messages&lt;br/&gt;to eligible executors]
    NoReads &amp; NoNewReads --&gt; Complete([Complete])</code></pre>
<figcaption>
<code>updateSeenAll</code> flowchart
</figcaption>
</figure>
<h4 id="explanation_3">Explanation<a class="headerlink" href="#explanation_3" title="Anchor link to this section for reference">¶</a></h4>
<ol>
<li>
<p><strong>Initial Request</strong></p>
<ul>
<li>A worker sends a <code>ShardMsgUpdateSeenAll</code> containing:<ul>
<li><code>timestamp</code>: The new barrier position in the transaction timeline.</li>
<li><code>write</code>: Boolean flag indicating if this updates the write barrier or read barrier.</li>
</ul>
</li>
<li>This represents a guarantee from the worker about transaction ordering.</li>
</ul>
</li>
<li>
<p><strong>Guard Phase</strong> (<code>updateSeenAllGuard</code>)</p>
<ul>
<li>Verifies message type is <code>ShardMsgUpdateSeenAll</code>.</li>
<li>If validation fails, request is rejected immediately.</li>
<li>On success, passes control to <code>updateSeenAllActionLabel</code>.</li>
</ul>
</li>
<li>
<p><strong>Action Phase</strong> (<code>updateSeenAllAction</code>)</p>
<ul>
<li>Processes valid update requests through these steps:<ul>
<li>Determines barrier type (write vs read) from message.</li>
<li>For write barriers:<ul>
<li>Updates <code>heardAllWrites</code> to new timestamp.</li>
<li>Checks for eager reads that can now execute.</li>
<li>Prepares read messages for eligible reads.</li>
</ul>
</li>
<li>For read barriers:<ul>
<li>Updates <code>heardAllReads</code> to new timestamp.</li>
<li>No immediate read processing needed.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Reply Generation</strong></p>
<ul>
<li>For write barrier updates:<ul>
<li>If eligible eager reads found:<ul>
<li>Creates <code>KVSRead</code> messages for each eligible read.</li>
<li>Includes value and timestamp for each read.</li>
</ul>
</li>
<li>If no eligible reads, completes with no messages.</li>
</ul>
</li>
<li>For read barrier updates:<ul>
<li>Always completes with no messages.</li>
<li>Read barrier updates are used for garbage collection, not triggering reads.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Message Delivery</strong></p>
<ul>
<li>Any generated read messages are sent to their respective executors.</li>
<li>No acknowledgment is sent back to the worker.</li>
</ul>
</li>
</ol>
<h2 id="action-arguments">Action arguments<a class="headerlink" href="#action-arguments" title="Anchor link to this section for reference">¶</a></h2>
<h3 id="shardactionargument"><code>ShardActionArgument</code><a class="headerlink" href="#shardactionargument" title="Anchor link to this section for reference">¶</a></h3>
<!-- --8<-- [start:ShardActionArgument] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span class="ju-keyword">type</span> <span id="ShardActionArgument"><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArgument"><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArgument"><span class="ju-inductive">ShardActionArgument</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-keyword">|</span> <span id="ShardActionArgument.ShardActionArgumentReplyTo"><span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArgument.ShardActionArgumentReplyTo"><span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArgument.ShardActionArgumentReplyTo"><span class="ju-constructor">ShardActionArgumentReplyTo</span></a></span></a></span></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#EngineID"><span class="ju-function">EngineID</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:ShardActionArgument] -->
<h3 id="shardactionarguments"><code>ShardActionArguments</code><a class="headerlink" href="#shardactionarguments" title="Anchor link to this section for reference">¶</a></h3>
<!-- --8<-- [start:shard-action-arguments] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="ShardActionArguments"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArguments"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArguments"><span class="ju-function">ShardActionArguments</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/List.html#List"><span class="ju-inductive">List</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArgument"><span class="ju-inductive">ShardActionArgument</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:shard-action-arguments] -->
<h2 id="helper-functions">Helper Functions<a class="headerlink" href="#helper-functions" title="Anchor link to this section for reference">¶</a></h2>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="findMostRecentWrite"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#findMostRecentWrite"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#findMostRecentWrite"><span class="ju-function">findMostRecentWrite</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:35"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:36"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:35"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:37"><span class="ju-var">dag</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:35"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:36"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:38"><span class="ju-var">key</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:35"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:39"><span class="ju-var">timestamp</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#TxFingerprint"><span class="ju-inductive">TxFingerprint</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:36"><span class="ju-var">KVSDatum</span></a></span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#lookup"><span class="ju-function">Map<span class="ju-delimiter">.</span>lookup</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:38"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:37"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">of</span><br/>    <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>    <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:40"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:40"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:40"><span class="ju-var">timestampMap</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">let</span><br/>        <span id="validEntries"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#validEntries"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#validEntries"><span class="ju-function">validEntries</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>          <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/List/Base.html#filter"><span class="ju-function">List<span class="ju-delimiter">.</span>filter</span></a></span><br/>            <span class="ju-keyword">\</span><span class="ju-delimiter">{</span><span id="arch.node.engines.shard_behaviour:41"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:41"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:41"><span class="ju-var">entry</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>              <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#fst"><span class="ju-function">fst</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:41"><span class="ju-var">entry</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#&lt;"><span class="ju-function">&lt;</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:39"><span class="ju-var">timestamp</span></a></span><br/>                <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Bool/Base.html#&amp;&amp;"><span class="ju-function">&amp;&amp;</span></a></span> <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess.writeStatus"><span class="ju-function">KeyAccess<span class="ju-delimiter">.</span>writeStatus</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#snd"><span class="ju-function"><span class="ju-delimiter">(</span>snd</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:41"><span class="ju-var">entry</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>                     <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:42"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:42"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:42"><span class="ju-var">writeStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                       <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Bool/Base.html#not"><span class="ju-function">not</span></a></span><br/>                         <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#WriteStatus.mayWrite"><span class="ju-function"><span class="ju-delimiter">(</span>WriteStatus<span class="ju-delimiter">.</span>mayWrite</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:42"><span class="ju-var">writeStatus</span></a></span><br/>                           <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Bool/Base.html#&amp;&amp;"><span class="ju-function">&amp;&amp;</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#isNone"><span class="ju-function">isNone</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#WriteStatus.data"><span class="ju-function"><span class="ju-delimiter">(</span>WriteStatus<span class="ju-delimiter">.</span>data</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:42"><span class="ju-var">writeStatus</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span><br/>                     <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span><br/>                   <span class="ju-delimiter">}</span><span class="ju-delimiter">}</span><br/>            <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#toList"><span class="ju-function"><span class="ju-delimiter">(</span>Map<span class="ju-delimiter">.</span>toList</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:40"><span class="ju-var">timestampMap</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>      <span class="ju-keyword">in</span> <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#maximumBy"><span class="ju-function">maximumBy</span></a></span> <span class="ju-keyword">\</span><span class="ju-delimiter">{</span><span id="arch.node.engines.shard_behaviour:46"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:46"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:46"><span class="ju-var">entry</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#fst"><span class="ju-function">fst</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:46"><span class="ju-var">entry</span></a></span><span class="ju-delimiter">}</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#validEntries"><span class="ju-function">validEntries</span></a></span> <span class="ju-keyword">of</span><br/>           <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#mkPair"><span class="ju-constructor"><span class="ju-delimiter">(</span>mkPair</span></a></span> <span class="ju-keyword">_</span> <span id="arch.node.engines.shard_behaviour:44"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:44"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:44"><span class="ju-var">access</span></a></span></a></span></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>             <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess.writeStatus"><span class="ju-function">KeyAccess<span class="ju-delimiter">.</span>writeStatus</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:44"><span class="ju-var">access</span></a></span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>               <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:45"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:45"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:45"><span class="ju-var">writeStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#WriteStatus.data"><span class="ju-function">WriteStatus<span class="ju-delimiter">.</span>data</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:45"><span class="ju-var">writeStatus</span></a></span><br/>               <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>             <span class="ju-delimiter">}</span><br/>           <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<p>-- add read without prior lock</p>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="addReadAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addReadAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addReadAccess"><span class="ju-function">addReadAccess</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:47"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:48"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:47"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:49"><span class="ju-var">dag</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:47"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:48"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:50"><span class="ju-var">key</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:47"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:51"><span class="ju-var">timestamp</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#TxFingerprint"><span class="ju-inductive">TxFingerprint</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:52"><span class="ju-var">readStatus</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ReadStatus"><span class="ju-inductive">ReadStatus</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:47"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:48"><span class="ju-var">KVSDatum</span></a></span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="keyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#lookup"><span class="ju-function">Map<span class="ju-delimiter">.</span>lookup</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:50"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:49"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">of</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#empty"><span class="ju-function">Map<span class="ju-delimiter">.</span>empty</span></a></span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:53"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:53"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:53"><span class="ju-var">m</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:53"><span class="ju-var">m</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="existingAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#existingAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#existingAccess"><span class="ju-function">existingAccess</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#lookup"><span class="ju-function">Map<span class="ju-delimiter">.</span>lookup</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:51"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span> <span class="ju-keyword">of</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span><br/>          <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess.mkKeyAccess"><span class="ju-constructor">KeyAccess<span class="ju-delimiter">.</span>mkKeyAccess</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>            <span id="arch.node.engines.shard_behaviour:55"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:55"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:55"><span class="ju-function">readStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span><br/>            <span id="arch.node.engines.shard_behaviour:56"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:56"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:56"><span class="ju-function">writeStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span><br/>          <span class="ju-delimiter">}</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:57"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:57"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:57"><span class="ju-var">access</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:57"><span class="ju-var">access</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="newAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newAccess"><span class="ju-function">newAccess</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#existingAccess"><span class="ju-function">existingAccess</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess"><span class="ju-inductive">KeyAccess</span></a></span><span class="ju-delimiter">{</span>readStatus <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:52"><span class="ju-var">readStatus</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>    <span id="newKeyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyMap"><span class="ju-function">newKeyMap</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#insert"><span class="ju-function">Map<span class="ju-delimiter">.</span>insert</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:51"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newAccess"><span class="ju-function">newAccess</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="newKeyAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyAccesses"><span class="ju-function">newKeyAccesses</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#insert"><span class="ju-function">Map<span class="ju-delimiter">.</span>insert</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:50"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyMap"><span class="ju-function">newKeyMap</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:49"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:49"><span class="ju-var">dag</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span><span class="ju-delimiter">{</span>keyAccesses <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyAccesses"><span class="ju-function">newKeyAccesses</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span></pre></code></pre>
<p>-- add write without prior lock</p>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="addWriteAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addWriteAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addWriteAccess"><span class="ju-function">addWriteAccess</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:67"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:68"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:67"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:69"><span class="ju-var">dag</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:67"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:68"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:70"><span class="ju-var">key</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:67"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:71"><span class="ju-var">timestamp</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#TxFingerprint"><span class="ju-inductive">TxFingerprint</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:72"><span class="ju-var">writeStatus</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#WriteStatus"><span class="ju-inductive">WriteStatus</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:68"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:67"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:68"><span class="ju-var">KVSDatum</span></a></span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="keyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#lookup"><span class="ju-function">Map<span class="ju-delimiter">.</span>lookup</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:70"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:69"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">of</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#empty"><span class="ju-function">Map<span class="ju-delimiter">.</span>empty</span></a></span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:73"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:73"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:73"><span class="ju-var">m</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:73"><span class="ju-var">m</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="existingAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#existingAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#existingAccess"><span class="ju-function">existingAccess</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#lookup"><span class="ju-function">Map<span class="ju-delimiter">.</span>lookup</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:71"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span> <span class="ju-keyword">of</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span><br/>          <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess.mkKeyAccess"><span class="ju-constructor">KeyAccess<span class="ju-delimiter">.</span>mkKeyAccess</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>            <span id="arch.node.engines.shard_behaviour:75"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:75"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:75"><span class="ju-function">readStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span><br/>            <span id="arch.node.engines.shard_behaviour:76"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:76"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:76"><span class="ju-function">writeStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span><br/>          <span class="ju-delimiter">}</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:77"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:77"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:77"><span class="ju-var">access</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:77"><span class="ju-var">access</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="newAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newAccess"><span class="ju-function">newAccess</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#existingAccess"><span class="ju-function">existingAccess</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess"><span class="ju-inductive">KeyAccess</span></a></span><span class="ju-delimiter">{</span>writeStatus <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:72"><span class="ju-var">writeStatus</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>    <span id="newKeyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyMap"><span class="ju-function">newKeyMap</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#insert"><span class="ju-function">Map<span class="ju-delimiter">.</span>insert</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:71"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newAccess"><span class="ju-function">newAccess</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="newKeyAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyAccesses"><span class="ju-function">newKeyAccesses</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#insert"><span class="ju-function">Map<span class="ju-delimiter">.</span>insert</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:70"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyMap"><span class="ju-function">newKeyMap</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:69"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:69"><span class="ju-var">dag</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span><span class="ju-delimiter">{</span>keyAccesses <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newKeyAccesses"><span class="ju-function">newKeyAccesses</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span></pre></code></pre>
<p>-- Replaces if read lock exists</p>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="replaceReadAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#replaceReadAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#replaceReadAccess"><span class="ju-function">replaceReadAccess</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:87"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:88"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:87"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:89"><span class="ju-var">dag</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:87"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:88"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:90"><span class="ju-var">key</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:87"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:91"><span class="ju-var">timestamp</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#TxFingerprint"><span class="ju-inductive">TxFingerprint</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive"><span class="ju-delimiter">(</span>DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:87"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:88"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="keyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#lookup"><span class="ju-function">Map<span class="ju-delimiter">.</span>lookup</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:90"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:89"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">of</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#empty"><span class="ju-function">Map<span class="ju-delimiter">.</span>empty</span></a></span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:92"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:92"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:92"><span class="ju-var">m</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:92"><span class="ju-var">m</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="access"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#access"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#access"><span class="ju-function">access</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#lookup"><span class="ju-function">Map<span class="ju-delimiter">.</span>lookup</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:91"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span> <span class="ju-keyword">of</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:94"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:94"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:94"><span class="ju-var">a</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:94"><span class="ju-var">a</span></a></span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#access"><span class="ju-function">access</span></a></span> <span class="ju-keyword">of</span><br/>       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:96"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:96"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:96"><span class="ju-var">a</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>         <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess.readStatus"><span class="ju-function">KeyAccess<span class="ju-delimiter">.</span>readStatus</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:96"><span class="ju-var">a</span></a></span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>           <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>           <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:97"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:97"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:97"><span class="ju-var">rs</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="ju-keyword">let</span><br/>               <span id="updatedReadStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedReadStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedReadStatus"><span class="ju-function">updatedReadStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:97"><span class="ju-var">rs</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ReadStatus"><span class="ju-inductive">ReadStatus</span></a></span><span class="ju-delimiter">{</span>hasBeenRead <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>               <span id="updatedAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedAccess"><span class="ju-function">updatedAccess</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                 <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:96"><span class="ju-var">a</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess"><span class="ju-inductive">KeyAccess</span></a></span><span class="ju-delimiter">{</span>readStatus <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedReadStatus"><span class="ju-function">updatedReadStatus</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>               <span id="updatedKeyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyMap"><span class="ju-function">updatedKeyMap</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#insert"><span class="ju-function">Map<span class="ju-delimiter">.</span>insert</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:91"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedAccess"><span class="ju-function">updatedAccess</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span><span class="ju-delimiter">;</span><br/>               <span id="updatedKeyAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyAccesses"><span class="ju-function">updatedKeyAccesses</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#insert"><span class="ju-function">Map<span class="ju-delimiter">.</span>insert</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:90"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyMap"><span class="ju-function">updatedKeyMap</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:89"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>             <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:89"><span class="ju-var">dag</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span><span class="ju-delimiter">{</span>keyAccesses <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyAccesses"><span class="ju-function">updatedKeyAccesses</span></a></span><span class="ju-delimiter">}</span><br/>         <span class="ju-delimiter">}</span><br/>       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<p>-- Replaces if write lock exists</p>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="replaceWriteAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#replaceWriteAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#replaceWriteAccess"><span class="ju-function">replaceWriteAccess</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:110"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:111"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:110"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:112"><span class="ju-var">dag</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:110"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:111"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:113"><span class="ju-var">key</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:110"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:114"><span class="ju-var">timestamp</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#TxFingerprint"><span class="ju-inductive">TxFingerprint</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:115"><span class="ju-var">newData</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:111"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive"><span class="ju-delimiter">(</span>DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:110"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:111"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="keyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#lookup"><span class="ju-function">Map<span class="ju-delimiter">.</span>lookup</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:113"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:112"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">of</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#empty"><span class="ju-function">Map<span class="ju-delimiter">.</span>empty</span></a></span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:116"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:116"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:116"><span class="ju-var">m</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:116"><span class="ju-var">m</span></a></span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#lookup"><span class="ju-function">Map<span class="ju-delimiter">.</span>lookup</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:114"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span> <span class="ju-keyword">of</span><br/>       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:118"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:118"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:118"><span class="ju-var">a</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>         <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess.writeStatus"><span class="ju-function">KeyAccess<span class="ju-delimiter">.</span>writeStatus</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:118"><span class="ju-var">a</span></a></span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>           <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>           <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:119"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:119"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:119"><span class="ju-var">ws</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#isNone"><span class="ju-function">isNone</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:115"><span class="ju-var">newData</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Bool/Base.html#&amp;&amp;"><span class="ju-function">&amp;&amp;</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Bool/Base.html#not"><span class="ju-function">not</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#WriteStatus.mayWrite"><span class="ju-function"><span class="ju-delimiter">(</span>WriteStatus<span class="ju-delimiter">.</span>mayWrite</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:119"><span class="ju-var">ws</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>               <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>               <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span> <span class="ju-keyword">:=</span><br/>                 <span class="ju-keyword">let</span><br/>                   <span id="data"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#data"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#data"><span class="ju-function">data</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                     <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:115"><span class="ju-var">newData</span></a></span> <span class="ju-keyword">of</span><br/>                       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#WriteStatus.data"><span class="ju-function">WriteStatus<span class="ju-delimiter">.</span>data</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:119"><span class="ju-var">ws</span></a></span><br/>                       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:120"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:120"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:120"><span class="ju-var">dat</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:120"><span class="ju-var">dat</span></a></span><span class="ju-delimiter">;</span><br/>                   <span id="updatedAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedAccess"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedAccess"><span class="ju-function">updatedAccess</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                     <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:118"><span class="ju-var">a</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess"><span class="ju-inductive">KeyAccess</span></a></span><span class="ju-delimiter">{</span>writeStatus <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>                       <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:119"><span class="ju-var">ws</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#WriteStatus"><span class="ju-inductive">WriteStatus</span></a></span><span class="ju-delimiter">{</span>data <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#data"><span class="ju-function">data</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>                   <span id="updatedKeyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyMap"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyMap"><span class="ju-function">updatedKeyMap</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#insert"><span class="ju-function">Map<span class="ju-delimiter">.</span>insert</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:114"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedAccess"><span class="ju-function">updatedAccess</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#keyMap"><span class="ju-function">keyMap</span></a></span><span class="ju-delimiter">;</span><br/>                   <span id="updatedKeyAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyAccesses"><span class="ju-function">updatedKeyAccesses</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                     <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#insert"><span class="ju-function">Map<span class="ju-delimiter">.</span>insert</span></a></span><br/>                       <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:113"><span class="ju-var">key</span></a></span><br/>                       <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyMap"><span class="ju-function">updatedKeyMap</span></a></span><br/>                       <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:112"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>                 <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:112"><span class="ju-var">dag</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span><span class="ju-delimiter">{</span>keyAccesses <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updatedKeyAccesses"><span class="ju-function">updatedKeyAccesses</span></a></span><span class="ju-delimiter">}</span><br/>             <span class="ju-delimiter">}</span><br/>         <span class="ju-delimiter">}</span><br/>       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="generateReadMsg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#generateReadMsg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#generateReadMsg"><span class="ju-function">generateReadMsg</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:132"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:133"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:134"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:135"><span class="ju-var">sender</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#EngineID"><span class="ju-function">EngineID</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:136"><span class="ju-var">key</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:132"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:137"><span class="ju-var">timestamp</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#TxFingerprint"><span class="ju-inductive">TxFingerprint</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:138"><span class="ju-var">data</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:133"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:139"><span class="ju-var">executor</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#EngineID"><span class="ju-function">EngineID</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg"><span class="ju-inductive">EngineMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:132"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:133"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:134"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>    <span id="arch.node.engines.shard_behaviour:140"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:140"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:140"><span class="ju-function">sender</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:135"><span class="ju-var">sender</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="arch.node.engines.shard_behaviour:141"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:141"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:141"><span class="ju-function">target</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:139"><span class="ju-var">executor</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="arch.node.engines.shard_behaviour:142"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:142"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:142"><span class="ju-function">mailbox</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="ju-number">0</span><span class="ju-delimiter">;</span><br/>    <span id="arch.node.engines.shard_behaviour:146"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:146"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:146"><span class="ju-function">msg</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span><br/>        <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.KVSRead"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>KVSRead</span></a></span><br/>          <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSReadMsg.mkKVSReadMsg"><span class="ju-constructor">KVSReadMsg<span class="ju-delimiter">.</span>mkKVSReadMsg</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>            <span id="arch.node.engines.shard_behaviour:143"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:143"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:143"><span class="ju-function">timestamp</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:137"><span class="ju-var">timestamp</span></a></span><span class="ju-delimiter">;</span><br/>            <span id="arch.node.engines.shard_behaviour:144"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:144"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:144"><span class="ju-function">key</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:136"><span class="ju-var">key</span></a></span><span class="ju-delimiter">;</span><br/>            <span id="arch.node.engines.shard_behaviour:145"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:145"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:145"><span class="ju-function">data</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:138"><span class="ju-var">data</span></a></span><span class="ju-delimiter">;</span><br/>          <span class="ju-delimiter">}</span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>  <span class="ju-delimiter">}</span><span class="ju-delimiter">;</span></pre></code></pre>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="execEagerReadsAtTime"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReadsAtTime"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReadsAtTime"><span class="ju-function">execEagerReadsAtTime</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:147"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:148"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:149"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:147"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:150"><span class="ju-var">sender</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#EngineID"><span class="ju-function">EngineID</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:151"><span class="ju-var">dag</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:147"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:148"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:152"><span class="ju-var">key</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:147"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:153"><span class="ju-var">timestamp</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#TxFingerprint"><span class="ju-inductive">TxFingerprint</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:154"><span class="ju-var">access</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess"><span class="ju-inductive">KeyAccess</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:148"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Data/Pair/Base.html#Pair"><span class="ju-inductive"><span class="ju-delimiter">(</span>Pair</span></a></span><br/>      <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive"><span class="ju-delimiter">(</span>DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:147"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:148"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>      <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>EngineMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:147"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:148"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:149"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess.readStatus"><span class="ju-function">KeyAccess<span class="ju-delimiter">.</span>readStatus</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:154"><span class="ju-var">access</span></a></span> <span class="ju-keyword">of</span><br/>    <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:155"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:155"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:155"><span class="ju-var">readStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">case</span><br/>        <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ReadStatus.isEager"><span class="ju-function">ReadStatus<span class="ju-delimiter">.</span>isEager</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:155"><span class="ju-var">readStatus</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Bool/Base.html#&amp;&amp;"><span class="ju-function">&amp;&amp;</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Bool/Base.html#not"><span class="ju-function">not</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ReadStatus.hasBeenRead"><span class="ju-function"><span class="ju-delimiter">(</span>ReadStatus<span class="ju-delimiter">.</span>hasBeenRead</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:155"><span class="ju-var">readStatus</span></a></span><span class="ju-delimiter">)</span><br/>      <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span> <span class="ju-keyword">:=</span><br/>          <span class="ju-keyword">case</span><br/>            <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:153"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#&lt;"><span class="ju-function">&lt;</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.heardAllWrites"><span class="ju-function">DAGStructure<span class="ju-delimiter">.</span>heardAllWrites</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:151"><span class="ju-var">dag</span></a></span><br/>              <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Bool/Base.html#&amp;&amp;"><span class="ju-function">&amp;&amp;</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:153"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#&gt;="><span class="ju-function">&gt;=</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.heardAllReads"><span class="ju-function">DAGStructure<span class="ju-delimiter">.</span>heardAllReads</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:151"><span class="ju-var">dag</span></a></span><br/>          <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>            <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span> <span class="ju-keyword">:=</span><br/>              <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#findMostRecentWrite"><span class="ju-function">findMostRecentWrite</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:151"><span class="ju-var">dag</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:152"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:153"><span class="ju-var">timestamp</span></a></span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>                <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:156"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:156"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:156"><span class="ju-var">data</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                  <span class="ju-keyword">let</span><br/>                    <span id="newReadStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newReadStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newReadStatus"><span class="ju-function">newReadStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:155"><span class="ju-var">readStatus</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ReadStatus"><span class="ju-inductive">ReadStatus</span></a></span><span class="ju-delimiter">{</span>hasBeenRead <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>                    <span id="newDag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newDag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newDag"><span class="ju-function">newDag</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addReadAccess"><span class="ju-function">addReadAccess</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:151"><span class="ju-var">dag</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:152"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:153"><span class="ju-var">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newReadStatus"><span class="ju-function">newReadStatus</span></a></span><span class="ju-delimiter">;</span><br/>                    <span id="msg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#msg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#msg"><span class="ju-function">msg</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                      <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#generateReadMsg"><span class="ju-function">generateReadMsg</span></a></span><br/>                        <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:150"><span class="ju-var">sender</span></a></span><br/>                        <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:152"><span class="ju-var">key</span></a></span><br/>                        <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:153"><span class="ju-var">timestamp</span></a></span><br/>                        <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:156"><span class="ju-var">data</span></a></span><br/>                        <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ReadStatus.executor"><span class="ju-function"><span class="ju-delimiter">(</span>ReadStatus<span class="ju-delimiter">.</span>executor</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:155"><span class="ju-var">readStatus</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>                  <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#mkPair"><span class="ju-constructor"><span class="ju-delimiter">(</span>mkPair</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newDag"><span class="ju-function">newDag</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#msg"><span class="ju-function">msg</span></a></span><span class="ju-delimiter">)</span><br/>                <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>              <span class="ju-delimiter">}</span><br/>            <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>          <span class="ju-delimiter">}</span><br/>        <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>      <span class="ju-delimiter">}</span><br/>    <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="execEagerReadsAtKey"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReadsAtKey"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReadsAtKey"><span class="ju-function">execEagerReadsAtKey</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:163"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:164"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:165"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:163"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:166"><span class="ju-var">sender</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#EngineID"><span class="ju-function">EngineID</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:167"><span class="ju-var">dag</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:163"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:164"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:168"><span class="ju-var">key</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:163"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:169"><span class="ju-var">timestampMap</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#Map"><span class="ju-inductive">Map</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#TxFingerprint"><span class="ju-inductive">TxFingerprint</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#KeyAccess"><span class="ju-inductive"><span class="ju-delimiter">(</span>KeyAccess</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:164"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Data/Pair/Base.html#Pair"><span class="ju-inductive">Pair</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive"><span class="ju-delimiter">(</span>DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:163"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:164"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/List.html#List"><span class="ju-inductive"><span class="ju-delimiter">(</span>List</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>EngineMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:163"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:164"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:165"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="processTimestamp"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processTimestamp"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processTimestamp"><span class="ju-function">processTimestamp</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">\</span><span class="ju-delimiter">{</span><span id="arch.node.engines.shard_behaviour:170"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:170"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:170"><span class="ju-var">k</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:171"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:171"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:171"><span class="ju-var">v</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:172"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:172"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:172"><span class="ju-var">acc</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>        <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:172"><span class="ju-var">acc</span></a></span> <span class="ju-keyword">of</span><br/>          <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#mkPair"><span class="ju-constructor">mkPair</span></a></span> <span id="arch.node.engines.shard_behaviour:173"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:173"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:173"><span class="ju-var">currDag</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:174"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:174"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:174"><span class="ju-var">msgs</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>            <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReadsAtTime"><span class="ju-function">execEagerReadsAtTime</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:166"><span class="ju-var">sender</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:173"><span class="ju-var">currDag</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:168"><span class="ju-var">key</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:170"><span class="ju-var">k</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:171"><span class="ju-var">v</span></a></span> <span class="ju-keyword">of</span><br/>              <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:175"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:175"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:175"><span class="ju-var">processed</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#mkPair"><span class="ju-constructor">mkPair</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#fst"><span class="ju-function"><span class="ju-delimiter">(</span>fst</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:175"><span class="ju-var">processed</span></a></span><span class="ju-delimiter">)</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#snd"><span class="ju-function"><span class="ju-delimiter">(</span>snd</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:175"><span class="ju-var">processed</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/List.html#List.::"><span class="ju-constructor">::</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:174"><span class="ju-var">msgs</span></a></span><span class="ju-delimiter">)</span><br/>              <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:172"><span class="ju-var">acc</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#foldr"><span class="ju-function">Map<span class="ju-delimiter">.</span>foldr</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processTimestamp"><span class="ju-function">processTimestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#mkPair"><span class="ju-constructor"><span class="ju-delimiter">(</span>mkPair</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:167"><span class="ju-var">dag</span></a></span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">)</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:169"><span class="ju-var">timestampMap</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="execEagerReads"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReads"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReads"><span class="ju-function">execEagerReads</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:177"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:178"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:179"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:177"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:180"><span class="ju-var">sender</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/identities.html#EngineID"><span class="ju-function">EngineID</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:181"><span class="ju-var">dag</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:177"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:178"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Data/Pair/Base.html#Pair"><span class="ju-inductive">Pair</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive"><span class="ju-delimiter">(</span>DAGStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:177"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:178"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/List.html#List"><span class="ju-inductive"><span class="ju-delimiter">(</span>List</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>EngineMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:177"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:178"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:179"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="processKey"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processKey"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processKey"><span class="ju-function">processKey</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="ju-keyword">\</span><span class="ju-delimiter">{</span><span id="arch.node.engines.shard_behaviour:182"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:182"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:182"><span class="ju-var">k</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:183"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:183"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:183"><span class="ju-var">v</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:184"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:184"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:184"><span class="ju-var">acc</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>        <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:184"><span class="ju-var">acc</span></a></span> <span class="ju-keyword">of</span><br/>          <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#mkPair"><span class="ju-constructor">mkPair</span></a></span> <span id="arch.node.engines.shard_behaviour:185"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:185"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:185"><span class="ju-var">currDag</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:186"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:186"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:186"><span class="ju-var">msgs</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>            <span class="ju-keyword">let</span><br/>              <span id="processed"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processed"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processed"><span class="ju-function">processed</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReadsAtKey"><span class="ju-function">execEagerReadsAtKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:180"><span class="ju-var">sender</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:185"><span class="ju-var">currDag</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:182"><span class="ju-var">k</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:183"><span class="ju-var">v</span></a></span><span class="ju-delimiter">;</span><br/>            <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#mkPair"><span class="ju-constructor">mkPair</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#fst"><span class="ju-function"><span class="ju-delimiter">(</span>fst</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processed"><span class="ju-function">processed</span></a></span><span class="ju-delimiter">)</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:186"><span class="ju-var"><span class="ju-delimiter">(</span>msgs</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/List/Base.html#++"><span class="ju-function">++</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#snd"><span class="ju-function">snd</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processed"><span class="ju-function">processed</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Map.html#foldr"><span class="ju-function">Map<span class="ju-delimiter">.</span>foldr</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processKey"><span class="ju-function">processKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#mkPair"><span class="ju-constructor"><span class="ju-delimiter">(</span>mkPair</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:181"><span class="ju-var">dag</span></a></span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">)</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.keyAccesses"><span class="ju-function"><span class="ju-delimiter">(</span>DAGStructure<span class="ju-delimiter">.</span>keyAccesses</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:181"><span class="ju-var">dag</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span></pre></code></pre>
<h2 id="actions">Actions<a class="headerlink" href="#actions" title="Anchor link to this section for reference">¶</a></h2>
<details class="code">
<summary>Auxiliary Juvix code</summary>
<h3 id="shardaction"><code>ShardAction</code><a class="headerlink" href="#shardaction" title="Anchor link to this section for reference">¶</a></h3>
<p><pre class="highlight"><code class="juvix"><pre class="src-content"><span id="ShardAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardAction"><span class="ju-function">ShardAction</span></a></span></a></span></span> <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:189"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:190"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:191"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:192"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#Action"><span class="ju-function">Action</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive"><span class="ju-delimiter">(</span>ShardLocalState</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:189"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:190"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardMailboxState"><span class="ju-inductive">ShardMailboxState</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArguments"><span class="ju-function">ShardActionArguments</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:189"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:190"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:191"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_config.html#PreCfg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:189"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:190"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:191"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_environment.html#PreEnv"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:189"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:190"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:191"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:192"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span></pre></code></pre></p>
<h3 id="shardactioninput"><code>ShardActionInput</code><a class="headerlink" href="#shardactioninput" title="Anchor link to this section for reference">¶</a></h3>
<p><pre class="highlight"><code class="juvix"><pre class="src-content"><span id="ShardActionInput"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionInput"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionInput"><span class="ju-function">ShardActionInput</span></a></span></a></span></span> <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:193"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:194"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:195"><span class="ju-var">Executable</span></a></span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput"><span class="ju-inductive">ActionInput</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive"><span class="ju-delimiter">(</span>ShardLocalState</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:193"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:194"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardMailboxState"><span class="ju-inductive">ShardMailboxState</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArguments"><span class="ju-function">ShardActionArguments</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:193"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:194"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:195"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span></pre></code></pre></p>
<h3 id="shardactioneffect"><code>ShardActionEffect</code><a class="headerlink" href="#shardactioneffect" title="Anchor link to this section for reference">¶</a></h3>
<p><pre class="highlight"><code class="juvix"><pre class="src-content"><span id="ShardActionEffect"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionEffect"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionEffect"><span class="ju-function">ShardActionEffect</span></a></span></a></span></span> <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:196"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:197"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:198"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:199"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionEffect"><span class="ju-inductive">ActionEffect</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive"><span class="ju-delimiter">(</span>ShardLocalState</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:196"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:197"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardMailboxState"><span class="ju-inductive">ShardMailboxState</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:196"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:197"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:198"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_config.html#PreCfg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:196"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:197"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:198"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_environment.html#PreEnv"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:196"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:197"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:198"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:199"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span></pre></code></pre></p>
<h3 id="shardactionexec"><code>ShardActionExec</code><a class="headerlink" href="#shardactionexec" title="Anchor link to this section for reference">¶</a></h3>
<p><pre class="highlight"><code class="juvix"><pre class="src-content"><span id="ShardActionExec"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionExec"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionExec"><span class="ju-function">ShardActionExec</span></a></span></a></span></span> <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:200"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:201"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:202"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:203"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionExec"><span class="ju-inductive">ActionExec</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive"><span class="ju-delimiter">(</span>ShardLocalState</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:200"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:201"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardMailboxState"><span class="ju-inductive">ShardMailboxState</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArguments"><span class="ju-function">ShardActionArguments</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:200"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:201"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:202"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_config.html#PreCfg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:200"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:201"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:202"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_environment.html#PreEnv"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:200"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:201"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:202"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:203"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span></pre></code></pre></p>
</details>
<h3 id="acquirelockaction"><code>acquireLockAction</code><a class="headerlink" href="#acquirelockaction" title="Anchor link to this section for reference">¶</a></h3>
<p>Process lock acquisition request and send confirmation.</p>
<dl>
<dt>State update</dt>
<dd>Update DAG with new read/write accesses.</dd>
<dt>Messages to be sent</dt>
<dd>KVSLockAcquired message to worker.</dd>
</dl>
<!-- --8<-- [start:acquireLockAction] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="acquireLockAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#acquireLockAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#acquireLockAction"><span class="ju-function">acquireLockAction</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:204"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:205"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:206"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:207"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:204"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:208"><span class="ju-var">input</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionInput"><span class="ju-function">ShardActionInput</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:204"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:205"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:206"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionEffect"><span class="ju-function"><span class="ju-delimiter">(</span>ShardActionEffect</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:204"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:205"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:206"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:207"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="cfg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="ju-function">cfg</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.cfg"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>cfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:208"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="env"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.env"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>env</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:208"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="local"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_environment.html#EngineEnv.localState"><span class="ju-function">EngineEnv<span class="ju-delimiter">.</span>localState</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="trigger"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="ju-function">trigger</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.trigger"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>trigger</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:208"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#getEngineMsgFromTimestampedTrigger"><span class="ju-function">getEngineMsgFromTimestampedTrigger</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="ju-function">trigger</span></a></span> <span class="ju-keyword">of</span><br/>       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                msg <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.KVSAcquireLock"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>KVSAcquireLock</span></a></span> <span id="arch.node.engines.shard_behaviour:213"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span></a></span></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>              <span class="ju-delimiter">}</span> <span class="ju-keyword">:=</span><br/>         <span class="ju-keyword">let</span><br/>           <span id="addEagerReadAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addEagerReadAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addEagerReadAccesses"><span class="ju-function">addEagerReadAccesses</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="ju-keyword">\</span><span class="ju-delimiter">{</span><span id="arch.node.engines.shard_behaviour:214"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:214"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:214"><span class="ju-var">key</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:215"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:215"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:215"><span class="ju-var">dag</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>               <span class="ju-keyword">let</span><br/>                 <span id="readStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readStatus"><span class="ju-function">readStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                   <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ReadStatus.mkReadStatus"><span class="ju-constructor">ReadStatus<span class="ju-delimiter">.</span>mkReadStatus</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                     <span id="arch.node.engines.shard_behaviour:216"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:216"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:216"><span class="ju-function">hasBeenRead</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span><span class="ju-delimiter">;</span><br/>                     <span id="arch.node.engines.shard_behaviour:217"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:217"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:217"><span class="ju-function">isEager</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span><span class="ju-delimiter">;</span><br/>                     <span id="arch.node.engines.shard_behaviour:218"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:218"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:218"><span class="ju-function">executor</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.executor"><span class="ju-function">KVSAcquireLockMsg<span class="ju-delimiter">.</span>executor</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">;</span><br/>                   <span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>               <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addReadAccess"><span class="ju-function">addReadAccess</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:215"><span class="ju-var">dag</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:214"><span class="ju-var">key</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.timestamp"><span class="ju-function"><span class="ju-delimiter">(</span>KVSAcquireLockMsg<span class="ju-delimiter">.</span>timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">)</span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readStatus"><span class="ju-function">readStatus</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>           <span id="addLazyReadAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addLazyReadAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addLazyReadAccesses"><span class="ju-function">addLazyReadAccesses</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="ju-keyword">\</span><span class="ju-delimiter">{</span><span id="arch.node.engines.shard_behaviour:221"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:221"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:221"><span class="ju-var">key</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:222"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:222"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:222"><span class="ju-var">dag</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>               <span class="ju-keyword">let</span><br/>                 <span id="readStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readStatus"><span class="ju-function">readStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                   <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ReadStatus.mkReadStatus"><span class="ju-constructor">ReadStatus<span class="ju-delimiter">.</span>mkReadStatus</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                     <span id="arch.node.engines.shard_behaviour:223"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:223"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:223"><span class="ju-function">hasBeenRead</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span><span class="ju-delimiter">;</span><br/>                     <span id="arch.node.engines.shard_behaviour:224"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:224"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:224"><span class="ju-function">isEager</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span><span class="ju-delimiter">;</span><br/>                     <span id="arch.node.engines.shard_behaviour:225"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:225"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:225"><span class="ju-function">executor</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.executor"><span class="ju-function">KVSAcquireLockMsg<span class="ju-delimiter">.</span>executor</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">;</span><br/>                   <span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>               <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addReadAccess"><span class="ju-function">addReadAccess</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:222"><span class="ju-var">dag</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:221"><span class="ju-var">key</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.timestamp"><span class="ju-function"><span class="ju-delimiter">(</span>KVSAcquireLockMsg<span class="ju-delimiter">.</span>timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">)</span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readStatus"><span class="ju-function">readStatus</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>           <span id="addWillWriteAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addWillWriteAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addWillWriteAccesses"><span class="ju-function">addWillWriteAccesses</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="ju-keyword">\</span><span class="ju-delimiter">{</span><span id="arch.node.engines.shard_behaviour:228"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:228"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:228"><span class="ju-var">key</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:229"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:229"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:229"><span class="ju-var">dag</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>               <span class="ju-keyword">let</span><br/>                 <span id="writeStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#writeStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#writeStatus"><span class="ju-function">writeStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                   <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#WriteStatus.mkWriteStatus"><span class="ju-constructor">WriteStatus<span class="ju-delimiter">.</span>mkWriteStatus</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                     <span id="arch.node.engines.shard_behaviour:230"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:230"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:230"><span class="ju-function">data</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span><br/>                     <span id="arch.node.engines.shard_behaviour:231"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:231"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:231"><span class="ju-function">mayWrite</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span><span class="ju-delimiter">;</span><br/>                   <span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>               <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addWriteAccess"><span class="ju-function">addWriteAccess</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:229"><span class="ju-var">dag</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:228"><span class="ju-var">key</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.timestamp"><span class="ju-function"><span class="ju-delimiter">(</span>KVSAcquireLockMsg<span class="ju-delimiter">.</span>timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">)</span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#writeStatus"><span class="ju-function">writeStatus</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>           <span id="addMayWriteAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addMayWriteAccesses"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addMayWriteAccesses"><span class="ju-function">addMayWriteAccesses</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="ju-keyword">\</span><span class="ju-delimiter">{</span><span id="arch.node.engines.shard_behaviour:234"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:234"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:234"><span class="ju-var">key</span></a></span></a></span></span> <span id="arch.node.engines.shard_behaviour:235"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:235"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:235"><span class="ju-var">dag</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>               <span class="ju-keyword">let</span><br/>                 <span id="writeStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#writeStatus"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#writeStatus"><span class="ju-function">writeStatus</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                   <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#WriteStatus.mkWriteStatus"><span class="ju-constructor">WriteStatus<span class="ju-delimiter">.</span>mkWriteStatus</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                     <span id="arch.node.engines.shard_behaviour:236"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:236"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:236"><span class="ju-function">data</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span><br/>                     <span id="arch.node.engines.shard_behaviour:237"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:237"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:237"><span class="ju-function">mayWrite</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span><span class="ju-delimiter">;</span><br/>                   <span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>               <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addWriteAccess"><span class="ju-function">addWriteAccess</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:235"><span class="ju-var">dag</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:234"><span class="ju-var">key</span></a></span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.timestamp"><span class="ju-function"><span class="ju-delimiter">(</span>KVSAcquireLockMsg<span class="ju-delimiter">.</span>timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">)</span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#writeStatus"><span class="ju-function">writeStatus</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>           <span id="dagWithEagerReads"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithEagerReads"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithEagerReads"><span class="ju-function">dagWithEagerReads</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Set.html#foldr"><span class="ju-function">Set<span class="ju-delimiter">.</span>foldr</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addEagerReadAccesses"><span class="ju-function">addEagerReadAccesses</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState.dagStructure"><span class="ju-function"><span class="ju-delimiter">(</span>ShardLocalState<span class="ju-delimiter">.</span>dagStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span><span class="ju-delimiter">)</span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.eager_read_keys"><span class="ju-function"><span class="ju-delimiter">(</span>KVSAcquireLockMsg<span class="ju-delimiter">.</span>eager_read_keys</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>           <span id="dagWithAllReads"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithAllReads"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithAllReads"><span class="ju-function">dagWithAllReads</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Set.html#foldr"><span class="ju-function">Set<span class="ju-delimiter">.</span>foldr</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addLazyReadAccesses"><span class="ju-function">addLazyReadAccesses</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithEagerReads"><span class="ju-function">dagWithEagerReads</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.lazy_read_keys"><span class="ju-function"><span class="ju-delimiter">(</span>KVSAcquireLockMsg<span class="ju-delimiter">.</span>lazy_read_keys</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>           <span id="dagWithWillWrites"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithWillWrites"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithWillWrites"><span class="ju-function">dagWithWillWrites</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Set.html#foldr"><span class="ju-function">Set<span class="ju-delimiter">.</span>foldr</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addWillWriteAccesses"><span class="ju-function">addWillWriteAccesses</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithAllReads"><span class="ju-function">dagWithAllReads</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.will_write_keys"><span class="ju-function"><span class="ju-delimiter">(</span>KVSAcquireLockMsg<span class="ju-delimiter">.</span>will_write_keys</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>           <span id="dagWithAllWrites"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithAllWrites"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithAllWrites"><span class="ju-function">dagWithAllWrites</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Data/Set.html#foldr"><span class="ju-function">Set<span class="ju-delimiter">.</span>foldr</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#addMayWriteAccesses"><span class="ju-function">addMayWriteAccesses</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithWillWrites"><span class="ju-function">dagWithWillWrites</span></a></span><br/>               <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.may_write_keys"><span class="ju-function"><span class="ju-delimiter">(</span>KVSAcquireLockMsg<span class="ju-delimiter">.</span>may_write_keys</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>           <span id="propagationResult"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="ju-function">propagationResult</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReads"><span class="ju-function">execEagerReads</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_config.html#getEngineIDFromEngineCfg"><span class="ju-function"><span class="ju-delimiter">(</span>getEngineIDFromEngineCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="ju-function">cfg</span></a></span><span class="ju-delimiter">)</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dagWithAllWrites"><span class="ju-function">dagWithAllWrites</span></a></span><span class="ju-delimiter">;</span><br/>           <span id="newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive">ShardLocalState</span></a></span><span class="ju-delimiter">{</span>dagStructure <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#fst"><span class="ju-function">fst</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="ju-function">propagationResult</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>           <span id="newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_environment.html#EngineEnv"><span class="ju-inductive">EngineEnv</span></a></span><span class="ju-delimiter">{</span>localState <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>         <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>           <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionEffect.mk"><span class="ju-constructor">ActionEffect<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>             <span id="arch.node.engines.shard_behaviour:253"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:253"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:253"><span class="ju-function">env</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span><span class="ju-delimiter">;</span><br/>             <span id="arch.node.engines.shard_behaviour:259"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:259"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:259"><span class="ju-function">msgs</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>               <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                 <span id="arch.node.engines.shard_behaviour:254"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:254"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:254"><span class="ju-function">sender</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_config.html#getEngineIDFromEngineCfg"><span class="ju-function">getEngineIDFromEngineCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.cfg"><span class="ju-function"><span class="ju-delimiter">(</span>ActionInput<span class="ju-delimiter">.</span>cfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:208"><span class="ju-var">input</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>                 <span id="arch.node.engines.shard_behaviour:255"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:255"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:255"><span class="ju-function">target</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.worker"><span class="ju-function">KVSAcquireLockMsg<span class="ju-delimiter">.</span>worker</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">;</span><br/>                 <span id="arch.node.engines.shard_behaviour:256"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:256"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:256"><span class="ju-function">mailbox</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="ju-number">0</span><span class="ju-delimiter">;</span><br/>                 <span id="arch.node.engines.shard_behaviour:258"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:258"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:258"><span class="ju-function">msg</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                   <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span><br/>                     <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.KVSLockAcquired"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>KVSLockAcquired</span></a></span><br/>                       <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSLockAcquiredMsg.mkKVSLockAcquiredMsg"><span class="ju-constructor">KVSLockAcquiredMsg<span class="ju-delimiter">.</span>mkKVSLockAcquiredMsg</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                         <span id="arch.node.engines.shard_behaviour:257"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:257"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:257"><span class="ju-function">timestamp</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSAcquireLockMsg.timestamp"><span class="ju-function">KVSAcquireLockMsg<span class="ju-delimiter">.</span>timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:213"><span class="ju-var">lockMsg</span></a></span><span class="ju-delimiter">;</span><br/>                       <span class="ju-delimiter">}</span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>               <span class="ju-delimiter">}</span><br/>                 <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/List.html#List.::"><span class="ju-constructor">::</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#snd"><span class="ju-function">snd</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="ju-function">propagationResult</span></a></span><span class="ju-delimiter">;</span><br/>             <span id="arch.node.engines.shard_behaviour:260"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:260"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:260"><span class="ju-function">timers</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>             <span id="arch.node.engines.shard_behaviour:261"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:261"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:261"><span class="ju-function">engines</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>           <span class="ju-delimiter">}</span><br/>       <span class="ju-keyword">|</span> <span class="ju-keyword">_</span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:acquireLockAction] -->
<h3 id="processwriteaction"><code>processWriteAction</code><a class="headerlink" href="#processwriteaction" title="Anchor link to this section for reference">¶</a></h3>
<p>Process write request and potentially trigger eager reads.</p>
<dl>
<dt>State update</dt>
<dd>Update DAG with write data and trigger eager reads.</dd>
<dt>Messages to be sent</dt>
<dd>KVSRead messages if eligible eager reads are found.</dd>
</dl>
<!-- --8<-- [start:processWriteAction] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="processWriteAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processWriteAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processWriteAction"><span class="ju-function">processWriteAction</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:262"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:263"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:264"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:265"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:262"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:266"><span class="ju-var">input</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionInput"><span class="ju-function">ShardActionInput</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:262"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:263"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:264"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionEffect"><span class="ju-function"><span class="ju-delimiter">(</span>ShardActionEffect</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:262"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:263"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:264"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:265"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="cfg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="ju-function">cfg</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.cfg"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>cfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:266"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="env"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.env"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>env</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:266"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="local"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_environment.html#EngineEnv.localState"><span class="ju-function">EngineEnv<span class="ju-delimiter">.</span>localState</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="trigger"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="ju-function">trigger</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.trigger"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>trigger</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:266"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#getEngineMsgFromTimestampedTrigger"><span class="ju-function">getEngineMsgFromTimestampedTrigger</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="ju-function">trigger</span></a></span> <span class="ju-keyword">of</span><br/>       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                msg <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.KVSWrite"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>KVSWrite</span></a></span> <span id="arch.node.engines.shard_behaviour:271"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:271"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:271"><span class="ju-var">writeMsg</span></a></span></a></span></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>              <span class="ju-delimiter">}</span> <span class="ju-keyword">:=</span><br/>         <span class="ju-keyword">let</span><br/>           <span id="dag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dag"><span class="ju-function">dag</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState.dagStructure"><span class="ju-function">ShardLocalState<span class="ju-delimiter">.</span>dagStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span><span class="ju-delimiter">;</span><br/>           <span id="key"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#key"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#key"><span class="ju-function">key</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSWriteMsg.key"><span class="ju-function">KVSWriteMsg<span class="ju-delimiter">.</span>key</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:271"><span class="ju-var">writeMsg</span></a></span><span class="ju-delimiter">;</span><br/>           <span id="timestamp"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#timestamp"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#timestamp"><span class="ju-function">timestamp</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSWriteMsg.timestamp"><span class="ju-function">KVSWriteMsg<span class="ju-delimiter">.</span>timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:271"><span class="ju-var">writeMsg</span></a></span><span class="ju-delimiter">;</span><br/>         <span class="ju-keyword">in</span> <span class="ju-keyword">case</span><br/>              <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#replaceWriteAccess"><span class="ju-function">replaceWriteAccess</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dag"><span class="ju-function">dag</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#key"><span class="ju-function">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#timestamp"><span class="ju-function">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSWriteMsg.datum"><span class="ju-function"><span class="ju-delimiter">(</span>KVSWriteMsg<span class="ju-delimiter">.</span>datum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:271"><span class="ju-var">writeMsg</span></a></span><span class="ju-delimiter">)</span><br/>            <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>              <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:275"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:275"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:275"><span class="ju-var">updatedDag</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                <span class="ju-keyword">let</span><br/>                  <span id="propagationResult"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="ju-function">propagationResult</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                    <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReads"><span class="ju-function">execEagerReads</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_config.html#getEngineIDFromEngineCfg"><span class="ju-function"><span class="ju-delimiter">(</span>getEngineIDFromEngineCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="ju-function">cfg</span></a></span><span class="ju-delimiter">)</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:275"><span class="ju-var">updatedDag</span></a></span><span class="ju-delimiter">;</span><br/>                  <span id="newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                    <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive">ShardLocalState</span></a></span><span class="ju-delimiter">{</span>dagStructure <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#fst"><span class="ju-function">fst</span></a></span><br/>                      <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="ju-function">propagationResult</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>                  <span id="newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_environment.html#EngineEnv"><span class="ju-inductive">EngineEnv</span></a></span><span class="ju-delimiter">{</span>localState <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>                  <span id="readMsgs"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readMsgs"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readMsgs"><span class="ju-function">readMsgs</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#snd"><span class="ju-function">snd</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="ju-function">propagationResult</span></a></span><span class="ju-delimiter">;</span><br/>                <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>                  <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionEffect.mk"><span class="ju-constructor">ActionEffect<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                    <span id="arch.node.engines.shard_behaviour:286"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:286"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:286"><span class="ju-function">env</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span><span class="ju-delimiter">;</span><br/>                    <span id="arch.node.engines.shard_behaviour:287"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:287"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:287"><span class="ju-function">msgs</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readMsgs"><span class="ju-function">readMsgs</span></a></span><span class="ju-delimiter">;</span><br/>                    <span id="arch.node.engines.shard_behaviour:288"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:288"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:288"><span class="ju-function">timers</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>                    <span id="arch.node.engines.shard_behaviour:289"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:289"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:289"><span class="ju-function">engines</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>                  <span class="ju-delimiter">}</span><br/>              <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>            <span class="ju-delimiter">}</span><br/>       <span class="ju-keyword">|</span> <span class="ju-keyword">_</span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:processWriteAction] -->
<h3 id="processreadrequestaction"><code>processReadRequestAction</code><a class="headerlink" href="#processreadrequestaction" title="Anchor link to this section for reference">¶</a></h3>
<p>Process read request and potentially send read response.</p>
<dl>
<dt>State update</dt>
<dd>Update DAG with read request status.</dd>
<dt>Messages to be sent</dt>
<dd>KVSRead message if read data is available.</dd>
</dl>
<!-- --8<-- [start:processReadRequestAction] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="processReadRequestAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processReadRequestAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processReadRequestAction"><span class="ju-function">processReadRequestAction</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:290"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:291"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:292"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:293"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:290"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:294"><span class="ju-var">input</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionInput"><span class="ju-function">ShardActionInput</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:290"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:291"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:292"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionEffect"><span class="ju-function"><span class="ju-delimiter">(</span>ShardActionEffect</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:290"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:291"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:292"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:293"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="cfg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="ju-function">cfg</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.cfg"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>cfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:294"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="env"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.env"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>env</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:294"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="local"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_environment.html#EngineEnv.localState"><span class="ju-function">EngineEnv<span class="ju-delimiter">.</span>localState</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="trigger"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="ju-function">trigger</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.trigger"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>trigger</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:294"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#getEngineMsgFromTimestampedTrigger"><span class="ju-function">getEngineMsgFromTimestampedTrigger</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="ju-function">trigger</span></a></span> <span class="ju-keyword">of</span><br/>       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                sender <span class="ju-keyword">:=</span> <span id="arch.node.engines.shard_behaviour:299"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:299"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:299"><span class="ju-var">sender</span></a></span></a></span></span><span class="ju-delimiter">;</span><br/>                msg <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.KVSReadRequest"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>KVSReadRequest</span></a></span> <span id="arch.node.engines.shard_behaviour:300"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:300"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:300"><span class="ju-var">readReqMsg</span></a></span></a></span></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>              <span class="ju-delimiter">}</span> <span class="ju-keyword">:=</span><br/>         <span class="ju-keyword">let</span><br/>           <span id="dag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dag"><span class="ju-function">dag</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState.dagStructure"><span class="ju-function">ShardLocalState<span class="ju-delimiter">.</span>dagStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span><span class="ju-delimiter">;</span><br/>           <span id="key"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#key"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#key"><span class="ju-function">key</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSReadRequestMsg.key"><span class="ju-function">KVSReadRequestMsg<span class="ju-delimiter">.</span>key</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:300"><span class="ju-var">readReqMsg</span></a></span><span class="ju-delimiter">;</span><br/>           <span id="timestamp"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#timestamp"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#timestamp"><span class="ju-function">timestamp</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSReadRequestMsg.timestamp"><span class="ju-function">KVSReadRequestMsg<span class="ju-delimiter">.</span>timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:300"><span class="ju-var">readReqMsg</span></a></span><span class="ju-delimiter">;</span><br/>           <span id="actual"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#actual"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#actual"><span class="ju-function">actual</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSReadRequestMsg.actual"><span class="ju-function">KVSReadRequestMsg<span class="ju-delimiter">.</span>actual</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:300"><span class="ju-var">readReqMsg</span></a></span><span class="ju-delimiter">;</span><br/>         <span class="ju-keyword">in</span> <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#timestamp"><span class="ju-function">timestamp</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#&gt;="><span class="ju-function">&gt;=</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure.heardAllReads"><span class="ju-function">DAGStructure<span class="ju-delimiter">.</span>heardAllReads</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dag"><span class="ju-function">dag</span></a></span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>              <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>              <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span> <span class="ju-keyword">:=</span><br/>                <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#replaceReadAccess"><span class="ju-function">replaceReadAccess</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#dag"><span class="ju-function">dag</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#key"><span class="ju-function">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#timestamp"><span class="ju-function">timestamp</span></a></span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>                  <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>                  <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:305"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:305"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:305"><span class="ju-var">updatedDag</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                    <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#actual"><span class="ju-function">actual</span></a></span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>                      <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span> <span class="ju-keyword">:=</span><br/>                        <span class="ju-keyword">let</span><br/>                          <span id="newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                            <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive">ShardLocalState</span></a></span><span class="ju-delimiter">{</span>dagStructure <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:305"><span class="ju-var">updatedDag</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>                          <span id="newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_environment.html#EngineEnv"><span class="ju-inductive">EngineEnv</span></a></span><span class="ju-delimiter">{</span>localState <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>                        <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>                          <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionEffect.mk"><span class="ju-constructor">ActionEffect<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                            <span id="arch.node.engines.shard_behaviour:314"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:314"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:314"><span class="ju-function">env</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span><span class="ju-delimiter">;</span><br/>                            <span id="arch.node.engines.shard_behaviour:315"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:315"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:315"><span class="ju-function">msgs</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>                            <span id="arch.node.engines.shard_behaviour:316"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:316"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:316"><span class="ju-function">timers</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>                            <span id="arch.node.engines.shard_behaviour:317"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:317"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:317"><span class="ju-function">engines</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>                          <span class="ju-delimiter">}</span><br/>                      <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span> <span class="ju-keyword">:=</span><br/>                        <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#findMostRecentWrite"><span class="ju-function">findMostRecentWrite</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:305"><span class="ju-var">updatedDag</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#key"><span class="ju-function">key</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#timestamp"><span class="ju-function">timestamp</span></a></span> <span class="ju-keyword">of</span> <span class="ju-delimiter">{</span><br/>                          <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><br/>                          <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span id="arch.node.engines.shard_behaviour:318"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:318"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:318"><span class="ju-var">data</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                            <span class="ju-keyword">let</span><br/>                              <span id="readMsg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readMsg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readMsg"><span class="ju-function">readMsg</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                                <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                                  <span id="arch.node.engines.shard_behaviour:319"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:319"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:319"><span class="ju-function">sender</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_config.html#getEngineIDFromEngineCfg"><span class="ju-function">getEngineIDFromEngineCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="ju-function">cfg</span></a></span><span class="ju-delimiter">;</span><br/>                                  <span id="arch.node.engines.shard_behaviour:320"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:320"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:320"><span class="ju-function">target</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:319"><span class="ju-function">sender</span></a></span><span class="ju-delimiter">;</span><br/>                                  <span id="arch.node.engines.shard_behaviour:321"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:321"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:321"><span class="ju-function">mailbox</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="ju-number">0</span><span class="ju-delimiter">;</span><br/>                                  <span id="arch.node.engines.shard_behaviour:325"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:325"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:325"><span class="ju-function">msg</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                                    <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span><br/>                                      <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.KVSRead"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>KVSRead</span></a></span><br/>                                        <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#KVSReadMsg.mkKVSReadMsg"><span class="ju-constructor">KVSReadMsg<span class="ju-delimiter">.</span>mkKVSReadMsg</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                                          <span id="arch.node.engines.shard_behaviour:322"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:322"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:322"><span class="ju-function">timestamp</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#timestamp"><span class="ju-function">timestamp</span></a></span><span class="ju-delimiter">;</span><br/>                                          <span id="arch.node.engines.shard_behaviour:323"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:323"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:323"><span class="ju-function">key</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#key"><span class="ju-function">key</span></a></span><span class="ju-delimiter">;</span><br/>                                          <span id="arch.node.engines.shard_behaviour:324"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:324"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:324"><span class="ju-function">data</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:318"><span class="ju-var">data</span></a></span><span class="ju-delimiter">;</span><br/>                                        <span class="ju-delimiter">}</span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>                                <span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>                              <span id="newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>                                <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive">ShardLocalState</span></a></span><span class="ju-delimiter">{</span>dagStructure <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:305"><span class="ju-var">updatedDag</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>                              <span id="newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_environment.html#EngineEnv"><span class="ju-inductive">EngineEnv</span></a></span><span class="ju-delimiter">{</span>localState <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>                            <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>                              <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionEffect.mk"><span class="ju-constructor">ActionEffect<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                                <span id="arch.node.engines.shard_behaviour:335"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:335"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:335"><span class="ju-function">env</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span><span class="ju-delimiter">;</span><br/>                                <span id="arch.node.engines.shard_behaviour:336"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:336"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:336"><span class="ju-function">msgs</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readMsg"><span class="ju-function">readMsg</span></a></span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>                                <span id="arch.node.engines.shard_behaviour:337"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:337"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:337"><span class="ju-function">timers</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>                                <span id="arch.node.engines.shard_behaviour:338"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:338"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:338"><span class="ju-function">engines</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>                              <span class="ju-delimiter">}</span><br/>                        <span class="ju-delimiter">}</span><br/>                    <span class="ju-delimiter">}</span><br/>                <span class="ju-delimiter">}</span><br/>            <span class="ju-delimiter">}</span><br/>       <span class="ju-keyword">|</span> <span class="ju-keyword">_</span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:processReadRequestAction] -->
<h3 id="updateseenallaction"><code>updateSeenAllAction</code><a class="headerlink" href="#updateseenallaction" title="Anchor link to this section for reference">¶</a></h3>
<p>Process seen-all update and potentially trigger eager reads.</p>
<dl>
<dt>State update</dt>
<dd>Update DAG barriers and trigger eager reads.</dd>
<dt>Messages to be sent</dt>
<dd>KVSRead messages if eligible eager reads are found.</dd>
</dl>
<!-- --8<-- [start:updateSeenAllAction] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="updateSeenAllAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updateSeenAllAction"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updateSeenAllAction"><span class="ju-function">updateSeenAllAction</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:339"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:340"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:341"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:342"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:339"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:343"><span class="ju-var">input</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionInput"><span class="ju-function">ShardActionInput</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:339"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:340"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:341"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionEffect"><span class="ju-function"><span class="ju-delimiter">(</span>ShardActionEffect</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:339"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:340"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:341"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:342"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">let</span><br/>    <span id="cfg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="ju-function">cfg</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.cfg"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>cfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:343"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="env"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.env"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>env</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:343"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="local"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_environment.html#EngineEnv.localState"><span class="ju-function">EngineEnv<span class="ju-delimiter">.</span>localState</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span><span class="ju-delimiter">;</span><br/>    <span id="trigger"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="ju-function">trigger</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionInput.trigger"><span class="ju-function">ActionInput<span class="ju-delimiter">.</span>trigger</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:343"><span class="ju-var">input</span></a></span><span class="ju-delimiter">;</span><br/>  <span class="ju-keyword">in</span> <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#getEngineMsgFromTimestampedTrigger"><span class="ju-function">getEngineMsgFromTimestampedTrigger</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#trigger"><span class="ju-function">trigger</span></a></span> <span class="ju-keyword">of</span><br/>       <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>                msg <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.UpdateSeenAll"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>UpdateSeenAll</span></a></span> <span id="arch.node.engines.shard_behaviour:348"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:348"><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:348"><span class="ju-var">updateMsg</span></a></span></a></span></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>              <span class="ju-delimiter">}</span> <span class="ju-keyword">:=</span><br/>         <span class="ju-keyword">let</span><br/>           <span id="oldDag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#oldDag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#oldDag"><span class="ju-function">oldDag</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState.dagStructure"><span class="ju-function">ShardLocalState<span class="ju-delimiter">.</span>dagStructure</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span><span class="ju-delimiter">;</span><br/>           <span id="newDag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newDag"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newDag"><span class="ju-function">newDag</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#UpdateSeenAllMsg.write"><span class="ju-function">UpdateSeenAllMsg<span class="ju-delimiter">.</span>write</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:348"><span class="ju-var">updateMsg</span></a></span> <span class="ju-keyword">of</span><br/>               <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span> <span class="ju-keyword">:=</span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#oldDag"><span class="ju-function">oldDag</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span><span class="ju-delimiter">{</span>heardAllWrites <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#UpdateSeenAllMsg.timestamp"><span class="ju-function">UpdateSeenAllMsg<span class="ju-delimiter">.</span>timestamp</span></a></span><br/>                   <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:348"><span class="ju-var">updateMsg</span></a></span><span class="ju-delimiter">}</span><br/>               <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span> <span class="ju-keyword">:=</span><br/>                 <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#oldDag"><span class="ju-function">oldDag</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#DAGStructure"><span class="ju-inductive">DAGStructure</span></a></span><span class="ju-delimiter">{</span>heardAllReads <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#UpdateSeenAllMsg.timestamp"><span class="ju-function">UpdateSeenAllMsg<span class="ju-delimiter">.</span>timestamp</span></a></span><br/>                   <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:348"><span class="ju-var">updateMsg</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>           <span id="propagationResult"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="ju-function">propagationResult</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#UpdateSeenAllMsg.write"><span class="ju-function">UpdateSeenAllMsg<span class="ju-delimiter">.</span>write</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:348"><span class="ju-var">updateMsg</span></a></span> <span class="ju-keyword">of</span><br/>               <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.true"><span class="ju-constructor">true</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#execEagerReads"><span class="ju-function">execEagerReads</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_config.html#getEngineIDFromEngineCfg"><span class="ju-function"><span class="ju-delimiter">(</span>getEngineIDFromEngineCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#cfg"><span class="ju-function">cfg</span></a></span><span class="ju-delimiter">)</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newDag"><span class="ju-function">newDag</span></a></span><br/>               <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/Bool.html#Bool.false"><span class="ju-constructor">false</span></a></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#mkPair"><span class="ju-constructor">mkPair</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newDag"><span class="ju-function">newDag</span></a></span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>           <span id="newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>             <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#local"><span class="ju-function">local</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive">ShardLocalState</span></a></span><span class="ju-delimiter">{</span>dagStructure <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#fst"><span class="ju-function">fst</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="ju-function">propagationResult</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>           <span id="newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#env"><span class="ju-function">env</span></a></span><span class="ju-keyword">@</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_environment.html#EngineEnv"><span class="ju-inductive">EngineEnv</span></a></span><span class="ju-delimiter">{</span>localState <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newLocal"><span class="ju-function">newLocal</span></a></span><span class="ju-delimiter">}</span><span class="ju-delimiter">;</span><br/>           <span id="readMsgs"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readMsgs"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readMsgs"><span class="ju-function">readMsgs</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#snd"><span class="ju-function">snd</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#propagationResult"><span class="ju-function">propagationResult</span></a></span><span class="ju-delimiter">;</span><br/>         <span class="ju-keyword">in</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>           <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionEffect.mk"><span class="ju-constructor">ActionEffect<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>             <span id="arch.node.engines.shard_behaviour:367"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:367"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:367"><span class="ju-function">env</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#newEnv"><span class="ju-function">newEnv</span></a></span><span class="ju-delimiter">;</span><br/>             <span id="arch.node.engines.shard_behaviour:368"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:368"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:368"><span class="ju-function">msgs</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#readMsgs"><span class="ju-function">readMsgs</span></a></span><span class="ju-delimiter">;</span><br/>             <span id="arch.node.engines.shard_behaviour:369"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:369"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:369"><span class="ju-function">timers</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>             <span id="arch.node.engines.shard_behaviour:370"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:370"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:370"><span class="ju-function">engines</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>           <span class="ju-delimiter">}</span><br/>       <span class="ju-keyword">|</span> <span class="ju-keyword">_</span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:updateSeenAllAction] -->
<h2 id="action-labels">Action Labels<a class="headerlink" href="#action-labels" title="Anchor link to this section for reference">¶</a></h2>
<h3 id="acquirelockactionlabel"><code>acquireLockActionLabel</code><a class="headerlink" href="#acquirelockactionlabel" title="Anchor link to this section for reference">¶</a></h3>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="acquireLockActionLabel"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#acquireLockActionLabel"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#acquireLockActionLabel"><span class="ju-function">acquireLockActionLabel</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:371"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:372"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:373"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:374"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:371"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionExec"><span class="ju-function">ShardActionExec</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:371"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:372"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:373"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:374"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionExec.Seq"><span class="ju-constructor">ActionExec<span class="ju-delimiter">.</span>Seq</span></a></span> <span class="ju-delimiter">[</span><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#acquireLockAction"><span class="ju-function">acquireLockAction</span></a></span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span></pre></code></pre>
<h3 id="processwriteactionlabel"><code>processWriteActionLabel</code><a class="headerlink" href="#processwriteactionlabel" title="Anchor link to this section for reference">¶</a></h3>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="processWriteActionLabel"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processWriteActionLabel"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processWriteActionLabel"><span class="ju-function">processWriteActionLabel</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:375"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:376"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:377"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:378"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:375"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionExec"><span class="ju-function">ShardActionExec</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:375"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:376"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:377"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:378"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionExec.Seq"><span class="ju-constructor">ActionExec<span class="ju-delimiter">.</span>Seq</span></a></span> <span class="ju-delimiter">[</span><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processWriteAction"><span class="ju-function">processWriteAction</span></a></span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span></pre></code></pre>
<h3 id="processreadrequestactionlabel"><code>processReadRequestActionLabel</code><a class="headerlink" href="#processreadrequestactionlabel" title="Anchor link to this section for reference">¶</a></h3>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="processReadRequestActionLabel"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processReadRequestActionLabel"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processReadRequestActionLabel"><span class="ju-function">processReadRequestActionLabel</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:379"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:380"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:381"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:382"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:379"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionExec"><span class="ju-function">ShardActionExec</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:379"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:380"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:381"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:382"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionExec.Seq"><span class="ju-constructor">ActionExec<span class="ju-delimiter">.</span>Seq</span></a></span> <span class="ju-delimiter">[</span><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processReadRequestAction"><span class="ju-function">processReadRequestAction</span></a></span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span></pre></code></pre>
<h3 id="updateseenallactionlabel"><code>updateSeenAllActionLabel</code><a class="headerlink" href="#updateseenallactionlabel" title="Anchor link to this section for reference">¶</a></h3>
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="updateSeenAllActionLabel"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updateSeenAllActionLabel"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updateSeenAllActionLabel"><span class="ju-function">updateSeenAllActionLabel</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:383"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:384"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:385"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:386"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:383"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionExec"><span class="ju-function">ShardActionExec</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:383"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:384"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:385"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:386"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#ActionExec.Seq"><span class="ju-constructor">ActionExec<span class="ju-delimiter">.</span>Seq</span></a></span> <span class="ju-delimiter">[</span><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updateSeenAllAction"><span class="ju-function">updateSeenAllAction</span></a></span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span></pre></code></pre>
<h2 id="guards">Guards<a class="headerlink" href="#guards" title="Anchor link to this section for reference">¶</a></h2>
<details class="code">
<summary>Auxiliary Juvix code</summary>
<h3 id="shardguard"><code>ShardGuard</code><a class="headerlink" href="#shardguard" title="Anchor link to this section for reference">¶</a></h3>
<p><pre class="highlight"><code class="juvix"><pre class="src-content"><span id="ShardGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuard"><span class="ju-function">ShardGuard</span></a></span></a></span></span> <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:387"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:388"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:389"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:390"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#Guard"><span class="ju-function">Guard</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive"><span class="ju-delimiter">(</span>ShardLocalState</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:387"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:388"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardMailboxState"><span class="ju-inductive">ShardMailboxState</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArguments"><span class="ju-function">ShardActionArguments</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:387"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:388"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:389"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_config.html#PreCfg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:387"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:388"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:389"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_environment.html#PreEnv"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:387"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:388"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:389"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:390"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span></pre></code></pre></p>
<h3 id="shardguardoutput"><code>ShardGuardOutput</code><a class="headerlink" href="#shardguardoutput" title="Anchor link to this section for reference">¶</a></h3>
<p><pre class="highlight"><code class="juvix"><pre class="src-content"><span id="ShardGuardOutput"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuardOutput"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuardOutput"><span class="ju-function">ShardGuardOutput</span></a></span></a></span></span> <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:391"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:392"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:393"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:394"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#GuardOutput"><span class="ju-inductive">GuardOutput</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive"><span class="ju-delimiter">(</span>ShardLocalState</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:391"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:392"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardMailboxState"><span class="ju-inductive">ShardMailboxState</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArguments"><span class="ju-function">ShardActionArguments</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:391"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:392"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:393"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_config.html#PreCfg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:391"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:392"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:393"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_environment.html#PreEnv"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:391"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:392"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:393"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:394"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span></pre></code></pre></p>
<h3 id="shardguardeval"><code>ShardGuardEval</code><a class="headerlink" href="#shardguardeval" title="Anchor link to this section for reference">¶</a></h3>
<p><pre class="highlight"><code class="juvix"><pre class="src-content"><span id="ShardGuardEval"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuardEval"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuardEval"><span class="ju-function">ShardGuardEval</span></a></span></a></span></span> <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:395"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:396"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:397"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:398"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#GuardEval"><span class="ju-inductive">GuardEval</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive"><span class="ju-delimiter">(</span>ShardLocalState</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:395"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:396"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardMailboxState"><span class="ju-inductive">ShardMailboxState</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArguments"><span class="ju-function">ShardActionArguments</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:395"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:396"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:397"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_config.html#PreCfg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:395"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:396"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:397"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_environment.html#PreEnv"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:395"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:396"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:397"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:398"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span></pre></code></pre></p>
</details>
<h3 id="acquirelockguard"><code>acquireLockGuard</code><a class="headerlink" href="#acquirelockguard" title="Anchor link to this section for reference">¶</a></h3>
<dl>
<dt>Condition</dt>
<dd>Message type is ShardMsgKVSAcquireLock.</dd>
</dl>
<!-- --8<-- [start:acquireLockGuard] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="acquireLockGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#acquireLockGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#acquireLockGuard"><span class="ju-function">acquireLockGuard</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:399"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:400"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:401"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:402"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:399"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:403"><span class="ju-var">trigger</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#TimestampedTrigger"><span class="ju-inductive">TimestampedTrigger</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:399"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:400"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:401"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:404"><span class="ju-var">cfg</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_config.html#EngineCfg"><span class="ju-inductive">EngineCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:405"><span class="ju-var">env</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardEnv"><span class="ju-function">ShardEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:399"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:400"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuardOutput"><span class="ju-function"><span class="ju-delimiter">(</span>ShardGuardOutput</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:399"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:400"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:401"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:402"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#getEngineMsgFromTimestampedTrigger"><span class="ju-function">getEngineMsgFromTimestampedTrigger</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:403"><span class="ju-var">trigger</span></a></span> <span class="ju-keyword">of</span><br/>    <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>             msg <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.KVSAcquireLock"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>KVSAcquireLock</span></a></span> <span class="ju-keyword">_</span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>           <span class="ju-delimiter">}</span> <span class="ju-keyword">:=</span><br/>      <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>        <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#GuardOutput.mk"><span class="ju-constructor">GuardOutput<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>          <span id="arch.node.engines.shard_behaviour:406"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:406"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:406"><span class="ju-function">action</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#acquireLockActionLabel"><span class="ju-function">acquireLockActionLabel</span></a></span><span class="ju-delimiter">;</span><br/>          <span id="arch.node.engines.shard_behaviour:407"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:407"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:407"><span class="ju-function">args</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>        <span class="ju-delimiter">}</span><br/>    <span class="ju-keyword">|</span> <span class="ju-keyword">_</span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:acquireLockGuard] -->
<h3 id="processwriteguard"><code>processWriteGuard</code><a class="headerlink" href="#processwriteguard" title="Anchor link to this section for reference">¶</a></h3>
<dl>
<dt>Condition</dt>
<dd>Message type is ShardMsgKVSWrite.</dd>
</dl>
<!-- --8<-- [start:processWriteGuard] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="processWriteGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processWriteGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processWriteGuard"><span class="ju-function">processWriteGuard</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:408"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:409"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:410"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:411"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:408"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:412"><span class="ju-var">trigger</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#TimestampedTrigger"><span class="ju-inductive">TimestampedTrigger</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:408"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:409"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:410"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:413"><span class="ju-var">cfg</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_config.html#EngineCfg"><span class="ju-inductive">EngineCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:414"><span class="ju-var">env</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardEnv"><span class="ju-function">ShardEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:408"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:409"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuardOutput"><span class="ju-function"><span class="ju-delimiter">(</span>ShardGuardOutput</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:408"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:409"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:410"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:411"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#getEngineMsgFromTimestampedTrigger"><span class="ju-function">getEngineMsgFromTimestampedTrigger</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:412"><span class="ju-var">trigger</span></a></span> <span class="ju-keyword">of</span><br/>    <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span>msg <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.KVSWrite"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>KVSWrite</span></a></span> <span class="ju-keyword">_</span><span class="ju-delimiter">)</span><span class="ju-delimiter">}</span> <span class="ju-keyword">:=</span><br/>      <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>        <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#GuardOutput.mk"><span class="ju-constructor">GuardOutput<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>          <span id="arch.node.engines.shard_behaviour:415"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:415"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:415"><span class="ju-function">action</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processWriteActionLabel"><span class="ju-function">processWriteActionLabel</span></a></span><span class="ju-delimiter">;</span><br/>          <span id="arch.node.engines.shard_behaviour:416"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:416"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:416"><span class="ju-function">args</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>        <span class="ju-delimiter">}</span><br/>    <span class="ju-keyword">|</span> <span class="ju-keyword">_</span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:processWriteGuard] -->
<h3 id="processreadrequestguard"><code>processReadRequestGuard</code><a class="headerlink" href="#processreadrequestguard" title="Anchor link to this section for reference">¶</a></h3>
<dl>
<dt>Condition</dt>
<dd>Message type is ShardMsgKVSReadRequest.</dd>
</dl>
<!-- --8<-- [start:processReadRequestGuard] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="processReadRequestGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processReadRequestGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processReadRequestGuard"><span class="ju-function">processReadRequestGuard</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:417"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:418"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:419"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:420"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:417"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:421"><span class="ju-var">trigger</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#TimestampedTrigger"><span class="ju-inductive">TimestampedTrigger</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:417"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:418"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:419"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:422"><span class="ju-var">cfg</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_config.html#EngineCfg"><span class="ju-inductive">EngineCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:423"><span class="ju-var">env</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardEnv"><span class="ju-function">ShardEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:417"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:418"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuardOutput"><span class="ju-function"><span class="ju-delimiter">(</span>ShardGuardOutput</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:417"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:418"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:419"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:420"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#getEngineMsgFromTimestampedTrigger"><span class="ju-function">getEngineMsgFromTimestampedTrigger</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:421"><span class="ju-var">trigger</span></a></span> <span class="ju-keyword">of</span><br/>    <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>             msg <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.KVSReadRequest"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>KVSReadRequest</span></a></span> <span class="ju-keyword">_</span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>           <span class="ju-delimiter">}</span> <span class="ju-keyword">:=</span><br/>      <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>        <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#GuardOutput.mk"><span class="ju-constructor">GuardOutput<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>          <span id="arch.node.engines.shard_behaviour:424"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:424"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:424"><span class="ju-function">action</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processReadRequestActionLabel"><span class="ju-function">processReadRequestActionLabel</span></a></span><span class="ju-delimiter">;</span><br/>          <span id="arch.node.engines.shard_behaviour:425"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:425"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:425"><span class="ju-function">args</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>        <span class="ju-delimiter">}</span><br/>    <span class="ju-keyword">|</span> <span class="ju-keyword">_</span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:processReadRequestGuard] -->
<h3 id="updateseenallguard"><code>updateSeenAllGuard</code><a class="headerlink" href="#updateseenallguard" title="Anchor link to this section for reference">¶</a></h3>
<dl>
<dt>Condition</dt>
<dd>Message type is ShardMsgUpdateSeenAll.</dd>
</dl>
<!-- --8<-- [start:updateSeenAllGuard] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="updateSeenAllGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updateSeenAllGuard"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updateSeenAllGuard"><span class="ju-function">updateSeenAllGuard</span></a></span></a></span></span><br/>  <span class="ju-delimiter">{</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:426"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:427"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:428"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:429"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">}</span><br/>  <span class="ju-delimiter">{{</span><span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Stdlib/Trait/Ord.html#Ord"><span class="ju-inductive">Ord</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:426"><span class="ju-var">KVSKey</span></a></span><span class="ju-delimiter">}}</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:430"><span class="ju-var">trigger</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#TimestampedTrigger"><span class="ju-inductive">TimestampedTrigger</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:426"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:427"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:428"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:431"><span class="ju-var">cfg</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_config.html#EngineCfg"><span class="ju-inductive">EngineCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:432"><span class="ju-var">env</span></a></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardEnv"><span class="ju-function">ShardEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:426"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:427"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>  <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#Option"><span class="ju-inductive">Option</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardGuardOutput"><span class="ju-function"><span class="ju-delimiter">(</span>ShardGuardOutput</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:426"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:427"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:428"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:429"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span> <span class="ju-keyword">:=</span><br/>  <span class="ju-keyword">case</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#getEngineMsgFromTimestampedTrigger"><span class="ju-function">getEngineMsgFromTimestampedTrigger</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:430"><span class="ju-var">trigger</span></a></span> <span class="ju-keyword">of</span><br/>    <span class="ju-keyword">|</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/messages.html#EngineMsg.mk"><span class="ju-constructor">EngineMsg<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>             msg <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg.MsgShard"><span class="ju-constructor">Anoma<span class="ju-delimiter">.</span>PreMsg<span class="ju-delimiter">.</span>MsgShard</span></a></span> <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_messages.html#ShardMsg.UpdateSeenAll"><span class="ju-constructor"><span class="ju-delimiter">(</span>ShardMsg<span class="ju-delimiter">.</span>UpdateSeenAll</span></a></span> <span class="ju-keyword">_</span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span><br/>           <span class="ju-delimiter">}</span> <span class="ju-keyword">:=</span><br/>      <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#some"><span class="ju-constructor">some</span></a></span><br/>        <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#GuardOutput.mk"><span class="ju-constructor">GuardOutput<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>          <span id="arch.node.engines.shard_behaviour:433"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:433"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:433"><span class="ju-function">action</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updateSeenAllActionLabel"><span class="ju-function">updateSeenAllActionLabel</span></a></span><span class="ju-delimiter">;</span><br/>          <span id="arch.node.engines.shard_behaviour:434"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:434"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:434"><span class="ju-function">args</span></a></span></a></span></span> <span class="ju-keyword">:=</span> <span class="ju-delimiter">[</span><span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>        <span class="ju-delimiter">}</span><br/>    <span class="ju-keyword">|</span> <span class="ju-keyword">_</span> <span class="ju-keyword">:=</span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/prelude.html#none"><span class="ju-constructor">none</span></a></span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:updateSeenAllGuard] -->
<h2 id="the-shard-behaviour">The Shard Behaviour<a class="headerlink" href="#the-shard-behaviour" title="Anchor link to this section for reference">¶</a></h2>
<h3 id="shardbehaviour"><code>ShardBehaviour</code><a class="headerlink" href="#shardbehaviour" title="Anchor link to this section for reference">¶</a></h3>
<!-- --8<-- [start:ShardBehaviour] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="ShardBehaviour"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardBehaviour"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardBehaviour"><span class="ju-function">ShardBehaviour</span></a></span></a></span></span> <span class="ju-delimiter">(</span><span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:435"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:436"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:437"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:438"><span class="ju-var">ProgramState</span></a></span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span><span class="ju-delimiter">)</span> <span class="ju-keyword">:</span> <span class="ju-keyword">Type</span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#EngineBehaviour"><span class="ju-inductive">EngineBehaviour</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_config.html#ShardCfg"><span class="ju-inductive">ShardCfg</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardLocalState"><span class="ju-inductive"><span class="ju-delimiter">(</span>ShardLocalState</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:435"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:436"><span class="ju-var">KVSDatum</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardMailboxState"><span class="ju-inductive">ShardMailboxState</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_environment.html#ShardTimerHandle"><span class="ju-inductive">ShardTimerHandle</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardActionArguments"><span class="ju-function">ShardActionArguments</span></a></span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_message.html#PreMsg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreMsg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:435"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:436"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:437"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_config.html#PreCfg"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreCfg</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:435"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:436"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:437"><span class="ju-var">Executable</span></a></span><span class="ju-delimiter">)</span><br/>    <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/arch/node/types/anoma_environment.html#PreEnv"><span class="ju-inductive"><span class="ju-delimiter">(</span>Anoma<span class="ju-delimiter">.</span>PreEnv</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:435"><span class="ju-var">KVSKey</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:436"><span class="ju-var">KVSDatum</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:437"><span class="ju-var">Executable</span></a></span> <span class="annot"><a class="ju-code-link ju-var" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:438"><span class="ju-var">ProgramState</span></a></span><span class="ju-delimiter">)</span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:ShardBehaviour] -->
<h4 id="instantiation">Instantiation<a class="headerlink" href="#instantiation" title="Anchor link to this section for reference">¶</a></h4>
<!-- --8<-- [start:shardBehaviour] -->
<pre class="highlight"><code class="juvix"><pre class="src-content"><span id="shardBehaviour"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#shardBehaviour"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#shardBehaviour"><span class="ju-function">shardBehaviour</span></a></span></a></span></span> <span class="ju-keyword">:</span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#ShardBehaviour"><span class="ju-function">ShardBehaviour</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/String.html#String"><span class="ju-axiom">String</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/String.html#String"><span class="ju-axiom">String</span></a></span> <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/prelude.html#ByteString"><span class="ju-function">ByteString</span></a></span> <span class="annot"><a class="ju-code-link ju-inductive" href="https://specs.anoma.net/pr-367/Juvix/Builtin/V1/String.html#String"><span class="ju-axiom">String</span></a></span> <span class="ju-keyword">:=</span><br/>  <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#EngineBehaviour.mk"><span class="ju-constructor">EngineBehaviour<span class="ju-delimiter">.</span>mk</span></a></span><span class="ju-keyword">@</span><span class="ju-delimiter">{</span><br/>    <span id="arch.node.engines.shard_behaviour:439"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:439"><span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#arch.node.engines.shard_behaviour:439"><span class="ju-function">guards</span></a></span></a></span></span> <span class="ju-keyword">:=</span><br/>      <span class="annot"><a class="ju-code-link ju-constructor" href="https://specs.anoma.net/pr-367/arch/node/types/engine_behaviour.html#GuardEval.First"><span class="ju-constructor">GuardEval<span class="ju-delimiter">.</span>First</span></a></span><br/>        <span class="ju-delimiter">[</span><br/>          <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#acquireLockGuard"><span class="ju-function">acquireLockGuard</span></a></span><span class="ju-delimiter">;</span><br/>          <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processWriteGuard"><span class="ju-function">processWriteGuard</span></a></span><span class="ju-delimiter">;</span><br/>          <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#processReadRequestGuard"><span class="ju-function">processReadRequestGuard</span></a></span><span class="ju-delimiter">;</span><br/>          <span class="annot"><a class="ju-code-link ju-function" href="https://specs.anoma.net/pr-367/arch/node/engines/shard_behaviour.html#updateSeenAllGuard"><span class="ju-function">updateSeenAllGuard</span></a></span><span class="ju-delimiter">;</span><br/>        <span class="ju-delimiter">]</span><span class="ju-delimiter">;</span><br/>  <span class="ju-delimiter">}</span><span class="ju-delimiter">;</span></pre></code></pre>
<!-- --8<-- [end:shardBehaviour] -->
<!-- list_wikilinks -->
<!-- Source file information -->
<!-- Was this page helpful? -->
<form class="md-feedback" hidden="" name="feedback">
<fieldset>
<legend class="md-feedback__title">
        Was this page helpful?
      </legend>
<div class="md-feedback__inner">
<div class="md-feedback__list">
<button class="md-feedback__icon md-icon" data-md-value="1" title="This page was helpful" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12 21.35-1.45-1.32C5.4 15.36 2 12.27 2 8.5 2 5.41 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.08C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.41 22 8.5c0 3.77-3.4 6.86-8.55 11.53z"></path></svg>
</button>
<button class="md-feedback__icon md-icon" data-md-value="0" title="This page could be improved" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12 21.35-1.45-1.32C5.4 15.36 2 12.27 2 8.5 2 5.41 4.42 3 7.5 3c.67 0 1.32.12 1.94.33L13 9.35l-4 5zM16.5 3C19.58 3 22 5.41 22 8.5c0 3.77-3.4 6.86-8.55 11.53L12 21.35l-1-7 4.5-5-2.65-5.08C13.87 3.47 15.17 3 16.5 3"></path></svg>
</button>
</div>
<div class="md-feedback__note">
<div data-md-value="1" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
<div data-md-value="0" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! We'll try to improve this page in the future.
            </div>
</div>
</div>
</fieldset>
</form>
<!-- Comment system -->
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Shard Environment" class="md-footer__link md-footer__link--prev" href="shard_environment.html">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.042.018.75.75 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                Previous
              </span>
<div class="md-ellipsis">
                Shard Environment
              </div>
</div>
</a>
<a aria-label="Next: Executor Engine" class="md-footer__link md-footer__link--next" href="executor.html">
<div class="md-footer__title">
<span class="md-footer__direction">
                Next
              </span>
<div class="md-ellipsis">
                Executor Engine
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8.22 2.97a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.042-.018.75.75 0 0 1-.018-1.042l2.97-2.97H3.75a.75.75 0 0 1 0-1.5h7.44L8.22 4.03a.75.75 0 0 1 0-1.06"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Powered by Mkdocs, Poetry , Material 9.6.12-insiders-4.53.16 and Juvix v0.6.10
    </div>
<strong>Version: (PR367 - ci-deploy-fix-bb30dd0f) - Updated: May 07,
    2025 at 03:42 PM UTC</strong>
<br/>
<strong>Latest version: <a href="https://specs.anoma.net/latest">
    https://specs.anoma.net/latest</a></strong>
<br/>
<strong>Development version: <a href="https://specs.anoma.net/main">
    https://specs.anoma.net/main</a></strong>
<br/>
<strong>Anoma Official Resources:</strong>
<small> <a href="https://anoma.net/" target="_blank">Website</a> | <a href="https://art.anoma.net" target="_blank">Research</a> | <a href="https://anoma.net/blog" target="_blank">Blog</a> | <a href="https://anoma.net/talks" target="_blank">Talks</a> </small>
<br/>
<strong>For Specification Authors:</strong>
<small>
<a href="https://specs.anoma.net/pr-367/indexes/tags.html">Tags</a>
    | <a href="https://specs.anoma.net/pr-367/indexes/links.html">Quick links</a>
    | <a href="https://specs.anoma.net/pr-367/indexes/juvix_modules.html">Juvix modules</a>
    | <a href="https://specs.anoma.net/pr-367/tutorial/index.html">Guides</a>
</small>
</div>
<div class="md-social">
<a class="md-social__link" href="https://x.com/anoma" rel="noopener" target="_blank" title="x.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"></path></svg>
</a>
<a class="md-social__link" href="https://github.com/anoma" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</a>
<a class="md-social__link" href="https://anoma.net/blog" rel="noopener" target="_blank" title="anoma.net">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M192 32c0 17.7 14.3 32 32 32 123.7 0 224 100.3 224 224 0 17.7 14.3 32 32 32s32-14.3 32-32C512 128.9 383.1 0 224 0c-17.7 0-32 14.3-32 32m0 96c0 17.7 14.3 32 32 32 70.7 0 128 57.3 128 128 0 17.7 14.3 32 32 32s32-14.3 32-32c0-106-86-192-192-192-17.7 0-32 14.3-32 32m-96 16c0-26.5-21.5-48-48-48S0 117.5 0 144v224c0 79.5 64.5 144 144 144s144-64.5 144-144-64.5-144-144-144h-16v96h16c26.5 0 48 21.5 48 48s-21.5 48-48 48-48-21.5-48-48z"></path></svg>
</a>
<a class="md-social__link" href="https://research.anoma.net" rel="noopener" target="_blank" title="research.anoma.net">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M225.9 32C103.3 32 0 130.5 0 252.1 0 256 .1 480 .1 480l225.8-.2c122.7 0 222.1-102.3 222.1-223.9S348.6 32 225.9 32M224 384c-19.4 0-37.9-4.3-54.4-12.1L88.5 392l22.9-75c-9.8-18.1-15.4-38.9-15.4-61 0-70.7 57.3-128 128-128s128 57.3 128 128-57.3 128-128 128"></path></svg>
</a>
<a class="md-social__link" href="https://youtube.com/anoma" rel="noopener" target="_blank" title="youtube.com">
<svg viewbox="0 0 576 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"></path></svg>
</a>
<a class="md-social__link" href="mailto:arts@heliax.dev" rel="noopener" target="_blank" title="">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.tooltips", "content.action.edit", "content.action.view", "search.highlight", "search.suggest", "search.sharing", "navigation.instant.preview", "navigation.tracking", "navigation.prune", "navigation.indexes", "navigation.sections", "navigation.footer", "navigation.path", "toc.follow"], "search": "../../../assets/javascripts/workers/search.c7c1ca2c.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.f807c082.min.js"></script>
<script src="../../../assets/js/extra.js"></script>
<script src="../../../assets/js/highlight.js"></script>
<script src="../../../assets/js/mathjax.js"></script>
<script src="../../../assets/js/tex-svg-full.js"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>